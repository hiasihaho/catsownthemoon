<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cats Own The Moon</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(to bottom, #0a0e27 0%, #1a1f4d 50%, #2d1b4e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .container {
            text-align: center;
            z-index: 10;
            position: relative;
        }

        .moon {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle at 30% 30%, #fff9e6 0%, #f0e68c 40%, #daa520 100%);
            border-radius: 50%;
            margin: 0 auto 40px;
            position: relative;
            box-shadow: 0 0 60px rgba(255, 255, 200, 0.8),
                        inset -20px -20px 40px rgba(0, 0, 0, 0.2);
            animation: float 6s ease-in-out infinite;
        }

        .crater {
            position: absolute;
            background: rgba(169, 169, 169, 0.3);
            border-radius: 50%;
        }

        .crater1 { width: 30px; height: 30px; top: 40px; left: 50px; }
        .crater2 { width: 20px; height: 20px; top: 80px; left: 120px; }
        .crater3 { width: 25px; height: 25px; top: 130px; left: 70px; }
        .crater4 { width: 15px; height: 15px; top: 60px; left: 140px; }

        .cat {
            position: absolute;
            font-size: 60px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: catFloat 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        @keyframes catFloat {
            0%, 100% { transform: translate(-50%, -50%) rotate(-5deg); }
            50% { transform: translate(-50%, -50%) rotate(5deg); }
        }

        h1 {
            font-size: 4rem;
            color: #fff9e6;
            text-shadow: 0 0 20px rgba(255, 255, 200, 0.8),
                         0 0 40px rgba(255, 255, 200, 0.5);
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px rgba(255, 255, 200, 0.8); }
            50% { text-shadow: 0 0 40px rgba(255, 255, 200, 1), 0 0 60px rgba(255, 255, 200, 0.8); }
        }

        p {
            font-size: 1.5rem;
            color: #b8b8ff;
            margin-top: 20px;
            text-shadow: 0 0 10px rgba(184, 184, 255, 0.5);
        }

        .paw-prints {
            position: absolute;
            font-size: 30px;
            opacity: 0.3;
            animation: float 8s ease-in-out infinite;
        }

        .paw1 { top: 10%; left: 15%; animation-delay: 0s; }
        .paw2 { top: 20%; right: 20%; animation-delay: 1s; }
        .paw3 { bottom: 15%; left: 25%; animation-delay: 2s; }
        .paw4 { bottom: 25%; right: 15%; animation-delay: 3s; }

        /* Chat Bubble Styles */
        .chat-bubble {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            z-index: 1000;
            animation: pulse 2s ease-in-out infinite;
        }

        .chat-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 4px 30px rgba(102, 126, 234, 0.8); }
        }

        /* Support Dialog Styles */
        .support-dialog {
            display: none;
            position: fixed;
            bottom: 110px;
            right: 30px;
            width: 400px;
            max-width: calc(100vw - 60px);
            max-height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 999;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
            flex-direction: column;
        }

        .support-dialog.active {
            display: flex;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Debug Modal Styles */
        .debug-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease-out;
        }

        .debug-modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .dialog-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dialog-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            transition: background 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .dialog-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .cat-image-container {
            width: 100%;
            height: 120px;
            background: #f5f5f5;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 15px 10px 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }

        .cat-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .model-status {
            padding: 10px 15px;
            background: #f0f0f0;
            font-size: 12px;
            color: #666;
            text-align: center;
            flex-shrink: 0;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            margin-top: 5px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: #f0f0f0;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            position: relative;
            padding: 10px 14px;
            display: flex;
            flex-direction: column;
        }

        .message-rating {
            display: flex;
            gap: 6px;
            padding-top: 10px;
            margin-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            justify-content: flex-end;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .message.assistant:hover .message-rating {
            opacity: 1;
        }

        .rating-btn {
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            padding: 6px 8px;
            transition: all 0.2s;
            filter: grayscale(80%);
        }

        .rating-btn:hover {
            transform: scale(1.1);
            filter: grayscale(0%);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .rating-btn.active {
            filter: grayscale(0%);
        }

        .learning-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            animation: slideInRight 0.3s ease-out, fadeOutDelay 3s ease-out;
            z-index: 2000;
            pointer-events: none;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOutDelay {
            0%, 90% { opacity: 1; }
            100% { opacity: 0; }
        }

        .message.system {
            background: #fff3cd;
            color: #856404;
            align-self: center;
            font-size: 12px;
            max-width: 95%;
            text-align: center;
        }

        .thinking-block {
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
            border-left: 4px solid #0284c7;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
            color: #0c4a6e;
            font-style: italic;
            position: relative;
        }

        .thinking-block::before {
            content: "üß† Thinking Process";
            display: block;
            font-weight: bold;
            margin-bottom: 6px;
            font-style: normal;
            color: #075985;
        }

        .thinking-toggle {
            cursor: pointer;
            color: #0284c7;
            font-size: 11px;
            margin-top: 4px;
            text-decoration: underline;
            user-select: none;
        }

        .thinking-content {
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .thinking-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            font-family: 'Arial', sans-serif;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s ease;
            white-space: nowrap;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            color: #667eea;
            font-size: 14px;
        }

        /* Rocket Training UI Styles */
        .training-rocket {
            position: fixed;
            bottom: 120px;
            left: 30px;
            width: 120px;
            height: 120px;
            cursor: pointer;
            z-index: 1000;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 4px 10px rgba(0, 0, 0, 0.2));
        }

        .training-rocket:hover {
            transform: scale(1.1) rotate(-5deg);
        }

        .rocket-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .fuel-gauge {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .fuel-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%);
            width: 0%;
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }

        .knowledge-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #f59e0b 0%, #dc2626 100%);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(245, 158, 11, 0.5);
            animation: pulse 2s ease-in-out infinite;
        }

        /* Training Panel */
        .training-panel {
            display: none;
            position: fixed;
            bottom: 110px;
            left: 30px;
            width: 350px;
            max-width: calc(100vw - 60px);
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 999;
            overflow: hidden;
            animation: slideUp 0.3s ease-out;
        }

        .training-panel.active {
            display: block;
        }

        .panel-header {
            background: linear-gradient(135deg, #f59e0b 0%, #dc2626 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .panel-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .stat-value {
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }

        .category-breakdown {
            margin-top: 15px;
        }

        .category-item {
            margin: 8px 0;
        }

        .category-name {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .category-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .category-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        /* Model Selector Styles */
        .model-selector-container {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

        .model-selector-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 5px;
            display: block;
        }

        .model-selector {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .model-selector:hover {
            border-color: #667eea;
        }

        .model-selector:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .model-info {
            font-size: 10px;
            color: #888;
            margin-top: 4px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: transform 0.2s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        /* Range Slider Styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            border: 3px solid #f59e0b;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            border-color: #d97706;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            border: 3px solid #f59e0b;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.2s;
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
            border-color: #d97706;
        }

        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .clear-btn {
            background: #fee;
            color: #c00;
        }

        .drop-zone {
            margin-top: 15px;
            padding: 30px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            text-align: center;
            color: #666;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: #f0f4ff;
            color: #667eea;
        }

        .drop-zone input {
            display: none;
        }

        /* Live Parameter Preview Footer */
        .param-preview-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, rgba(26, 31, 77, 0.95) 0%, rgba(45, 27, 78, 0.95) 100%);
            backdrop-filter: blur(10px);
            border-top: 2px solid rgba(102, 126, 234, 0.3);
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            z-index: 10001;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            font-family: 'Courier New', monospace;
        }

        .param-group {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .param-item {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .param-item.changed {
            background: rgba(102, 126, 234, 0.4);
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
            animation: paramPulse 0.5s ease-out;
        }

        @keyframes paramPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .param-label {
            color: rgba(184, 184, 255, 0.8);
            font-weight: bold;
        }

        .param-value {
            color: #4ade80;
            font-weight: bold;
        }

        .param-value.auto {
            color: #fbbf24;
        }

        .toggle-footer-btn {
            background: rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(102, 126, 234, 0.5);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s ease;
        }

        .toggle-footer-btn:hover {
            background: rgba(102, 126, 234, 0.5);
            transform: translateY(-1px);
        }

        .tooltip-hint {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip-hint::after {
            content: attr(data-hint);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            margin-bottom: 5px;
            z-index: 10002;
        }

        .tooltip-hint:hover::after {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>

    <div class="paw-prints paw1">üêæ</div>
    <div class="paw-prints paw2">üêæ</div>
    <div class="paw-prints paw3">üêæ</div>
    <div class="paw-prints paw4">üêæ</div>

    <div class="container">
        <div class="moon">
            <div class="crater crater1"></div>
            <div class="crater crater2"></div>
            <div class="crater crater3"></div>
            <div class="crater crater4"></div>
            <div class="cat">üê±</div>
        </div>

        <h1>Hello World!</h1>
        <p>Welcome to the moon... where cats reign supreme! üåô</p>
    </div>

    <!-- Chat Bubble -->
    <div class="chat-bubble" id="chatBubble">
        üí¨
    </div>

    <!-- Training Rocket -->
    <div class="training-rocket" id="trainingRocket">
        <div class="rocket-container">
            <div class="knowledge-badge" id="knowledgeBadge">0</div>
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <!-- Rocket body -->
                <ellipse cx="50" cy="60" rx="15" ry="25" fill="#e74c3c"/>
                <rect x="35" y="50" width="30" height="30" fill="#c0392b"/>
                <!-- Window -->
                <circle cx="50" cy="55" r="8" fill="#3498db" opacity="0.7"/>
                <!-- Cat astronaut inside -->
                <text x="50" y="60" font-size="12" text-anchor="middle">üò∫</text>
                <!-- Rocket fins -->
                <polygon points="35,75 25,90 35,85" fill="#95a5a6"/>
                <polygon points="65,75 75,90 65,85" fill="#95a5a6"/>
                <!-- Rocket nose -->
                <polygon points="50,30 35,50 65,50" fill="#e67e22"/>
                <!-- Flames -->
                <g id="flames">
                    <ellipse cx="50" cy="85" rx="8" ry="6" fill="#f39c12" opacity="0.8">
                        <animate attributeName="ry" values="6;10;6" dur="0.3s" repeatCount="indefinite"/>
                    </ellipse>
                    <ellipse cx="50" cy="90" rx="6" ry="8" fill="#e74c3c" opacity="0.6">
                        <animate attributeName="ry" values="8;12;8" dur="0.4s" repeatCount="indefinite"/>
                    </ellipse>
                </g>
            </svg>
            <div class="fuel-gauge">
                <div class="fuel-fill" id="fuelFill"></div>
            </div>
        </div>
    </div>

    <!-- Training Panel -->
    <div class="training-panel" id="trainingPanel">
        <div class="panel-header">
            <h3>üöÄ Learning Analytics</h3>
            <button class="close-btn" id="closePanelBtn">√ó</button>
        </div>
        <div class="panel-content">
            <div class="stat-item">
                <span class="stat-label">Total Knowledge</span>
                <span class="stat-value" id="statTotal">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">All Rated</span>
                <span class="stat-value" id="statLiked">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Learning Progress</span>
                <span class="stat-value" id="statProgress">0%</span>
            </div>

            <!-- Star Rating Breakdown -->
            <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border-left: 4px solid #f59e0b;">
                <h4 style="font-size: 14px; margin-bottom: 10px; color: #92400e;">‚≠ê Quality Breakdown</h4>
                <div class="stat-item" style="border: none; padding: 5px 0;">
                    <span class="stat-label">‚≠ê‚≠ê‚≠ê Excellent:</span>
                    <span class="stat-value" id="statStar3">0</span>
                </div>
                <div class="stat-item" style="border: none; padding: 5px 0;">
                    <span class="stat-label">‚≠ê‚≠ê Good:</span>
                    <span class="stat-value" id="statStar2">0</span>
                </div>
                <div class="stat-item" style="border: none; padding: 5px 0;">
                    <span class="stat-label">‚≠ê Okay:</span>
                    <span class="stat-value" id="statStar1">0</span>
                </div>
                <div class="stat-item" style="border: none; padding: 5px 0;">
                    <span class="stat-label">üëé Bad:</span>
                    <span class="stat-value" id="statDown">0</span>
                </div>
            </div>

            <div class="category-breakdown" id="categoryBreakdown">
                <h4 style="font-size: 14px; margin-bottom: 10px; color: #333;">Knowledge Categories</h4>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 10px; border-left: 4px solid #0284c7;">
                <h4 style="font-size: 14px; margin-bottom: 10px; color: #0c4a6e;">üéì Training Export</h4>
                <div class="stat-item" style="border: none; padding: 5px 0;">
                    <span class="stat-label">Training Examples:</span>
                    <span class="stat-value" id="trainingExamples">0</span>
                </div>
                <div class="stat-item" style="border: none; padding: 5px 0;">
                    <span class="stat-label">Preference Pairs (DPO):</span>
                    <span class="stat-value" id="preferencePairs">0</span>
                </div>
                <div class="stat-item" style="border: none; padding: 5px 0;">
                    <span class="stat-label">Quality Score:</span>
                    <span class="stat-value" id="qualityScore">0%</span>
                </div>
                <p style="font-size: 11px; color: #64748b; margin-top: 10px; line-height: 1.4;">
                    Export creates a ready-to-train package with Alpaca/DPO formats, training script, and config. Train on your own GPU or Google Colab!
                </p>
            </div>

            <div class="action-buttons">
                <button class="action-btn export-btn" id="exportBtn">üì¶ Export Training Package</button>
                <button class="action-btn clear-btn" id="clearBtn">üóëÔ∏è Clear</button>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border-left: 4px solid #f59e0b;">
                <h4 style="font-size: 14px; margin-bottom: 10px; color: #92400e;">üìö Upload Knowledge Base</h4>
                <p style="font-size: 11px; color: #78350f; margin-bottom: 10px; line-height: 1.4;">
                    Upload long texts (stories, documentation, etc.) to expand the AI's knowledge. Text will be automatically chunked and converted to Q&A pairs with embeddings.
                </p>
                <textarea id="textUpload" placeholder="Paste your text here... (e.g., a story about cats on the moon)"
                    style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid #fbbf24; border-radius: 8px; font-size: 12px; font-family: Arial; resize: vertical;"></textarea>
                <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                    <button id="processTextBtn" class="action-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        ‚ö° Process & Add to Knowledge
                    </button>
                    <span id="uploadStatus" style="font-size: 11px; color: #78350f;"></span>
                </div>
                <div id="uploadProgress" style="margin-top: 10px; display: none;">
                    <div style="background: #fef3c7; border-radius: 4px; height: 8px; overflow: hidden;">
                        <div id="uploadProgressBar" style="background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <p id="uploadProgressText" style="font-size: 10px; color: #78350f; margin-top: 4px;">Processing...</p>
                </div>
            </div>

            <!-- DEBUG TOOLS SECTION -->
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%); border-radius: 10px; border-left: 4px solid #8b5cf6;">
                <h4 style="font-size: 14px; margin-bottom: 10px; color: #4c1d95;">üîß Debug Tools</h4>
                <p style="font-size: 11px; color: #5b21b6; margin-bottom: 10px; line-height: 1.4;">
                    View and manage your knowledge database, inspect RAG decisions, and debug AI behavior.
                </p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;">
                    <button id="viewDatabaseBtn" class="action-btn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; font-size: 11px; padding: 8px 12px;">
                        üìä View Database
                    </button>
                    <button id="clearLearningsBtn" class="action-btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-size: 11px; padding: 8px 12px;">
                        üóëÔ∏è Clear Learnings
                    </button>
                    <button id="toggleRAGInspectorBtn" class="action-btn" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; font-size: 11px; padding: 8px 12px;">
                        üîç RAG Inspector
                    </button>
                    <button id="toggleConsoleLogBtn" class="action-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 11px; padding: 8px 12px;">
                        üìú Console Viewer
                    </button>
                </div>
            </div>

            <!-- ADVANCED CONTROLS SECTION -->
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border-left: 4px solid #f59e0b;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer;" id="advancedControlsHeader">
                    <h4 style="font-size: 14px; margin: 0; color: #78350f;">‚öôÔ∏è Advanced Controls</h4>
                    <span id="advancedControlsToggle" style="font-size: 18px; color: #78350f;">‚ñº</span>
                </div>
                <div id="advancedControlsContent" style="display: block;">
                    <p style="font-size: 11px; color: #92400e; margin-bottom: 15px; line-height: 1.4;">
                        Fine-tune AI behavior: creativity level, RAG influence, and system instructions.
                    </p>

                    <!-- Creativity Slider -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <label style="font-size: 12px; font-weight: bold; color: #78350f;">üé® Creativity Level</label>
                            <span id="creativityValue" style="font-size: 12px; color: #92400e; font-family: monospace;">0.7</span>
                        </div>
                        <input type="range" id="creativitySlider" min="0.1" max="1.5" step="0.1" value="0.7"
                            style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #3b82f6 0%, #f59e0b 50%, #ef4444 100%); outline: none; -webkit-appearance: none;">
                        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #92400e; margin-top: 4px;">
                            <span>Conservative</span>
                            <span>Balanced</span>
                            <span>Creative</span>
                        </div>
                        <p style="font-size: 10px; color: #92400e; margin-top: 6px; font-style: italic;">
                            Controls randomness & variety in responses
                        </p>
                    </div>

                    <!-- RAG Influence Slider -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <label style="font-size: 12px; font-weight: bold; color: #78350f;">üß† RAG Influence</label>
                            <span id="ragInfluenceValue" style="font-size: 12px; color: #92400e; font-family: monospace;">0.5</span>
                        </div>
                        <input type="range" id="ragInfluenceSlider" min="0" max="1" step="0.1" value="0.5"
                            style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #8b5cf6 0%, #10b981 100%); outline: none; -webkit-appearance: none;">
                        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #92400e; margin-top: 4px;">
                            <span>Pure LLM</span>
                            <span>Blended</span>
                            <span>RAG Only</span>
                        </div>
                        <p style="font-size: 10px; color: #92400e; margin-top: 6px; font-style: italic;">
                            0 = Ignore database | 0.5 = Balance | 1 = Only use stored answers
                        </p>
                    </div>

                    <!-- Minimum RAG Temperature Slider -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <label style="font-size: 12px; font-weight: bold; color: #78350f;">üå°Ô∏è Min RAG Temperature</label>
                            <span id="minRagTempValue" style="font-size: 12px; color: #92400e; font-family: monospace;">0.4</span>
                        </div>
                        <input type="range" id="minRagTempSlider" min="0.1" max="1.0" step="0.1" value="0.4"
                            style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #ef4444 0%, #f59e0b 50%, #10b981 100%); outline: none; -webkit-appearance: none;">
                        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #92400e; margin-top: 4px;">
                            <span>Disabled</span>
                            <span>Balanced</span>
                            <span>Strict</span>
                        </div>
                        <p style="font-size: 10px; color: #92400e; margin-top: 6px; font-style: italic; line-height: 1.4;">
                            <strong>Auto-boosts low creativity when RAG results exist.</strong><br>
                            ‚Ä¢ 0.1 = Disabled (allow any creativity)<br>
                            ‚Ä¢ 0.4 = Balanced (recommended - prevents ignoring RAG)<br>
                            ‚Ä¢ 0.6+ = Strict (forces RAG adherence even with low creativity)
                        </p>
                        <div style="background: #fef3c7; border-left: 3px solid #f59e0b; padding: 8px; margin-top: 8px; border-radius: 4px;">
                            <div style="font-size: 10px; color: #78350f; line-height: 1.4;">
                                <strong>üí° Why this matters:</strong> At very low temperature (&lt;0.4), TinyLlama ignores RAG context and follows base training patterns. This setting prevents that by auto-boosting temperature when database results are found.
                            </div>
                        </div>
                    </div>

                    <!-- System Prompt Editor -->
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <label style="font-size: 12px; font-weight: bold; color: #78350f;">üìù System Prompt</label>
                            <button id="resetPromptBtn" style="font-size: 10px; padding: 4px 8px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                üîÑ Reset
                            </button>
                        </div>
                        <textarea id="systemPromptEditor"
                            style="width: 100%; min-height: 80px; padding: 8px; font-size: 11px; font-family: monospace; border: 2px solid #fbbf24; border-radius: 6px; background: #fffbeb; color: #78350f; resize: vertical;"
                            placeholder="Enter system instructions..."></textarea>
                        <p style="font-size: 10px; color: #92400e; margin-top: 6px; font-style: italic;">
                            Changes apply immediately to next message
                        </p>
                    </div>

                    <!-- Save Button -->
                    <button id="saveAdvancedSettings" class="action-btn"
                        style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 12px; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        üíæ Save Settings
                    </button>
                </div>
            </div>

            <!-- EXPERIMENTAL PARAMETERS SECTION -->
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 10px; border-left: 4px solid #0284c7;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; cursor: pointer;" id="experimentalParamsHeader">
                    <h4 style="font-size: 14px; margin: 0; color: #0c4a6e;">üß™ Experimental Parameters</h4>
                    <span id="experimentalParamsToggle" style="font-size: 18px; color: #0c4a6e;">‚ñº</span>
                </div>
                <div id="experimentalParamsContent" style="display: block;">
                    <p style="font-size: 11px; color: #075985; margin-bottom: 15px; line-height: 1.4;">
                        Fine-tune LLM behavior at the parameter level. Each setting has tooltips explaining its effect with examples.
                    </p>

                    <!-- Auto-Adjust Toggle -->
                    <div style="background: #fef3c7; border-left: 3px solid #f59e0b; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 12px; color: #78350f;">
                            <input type="checkbox" id="autoAdjustToggle" checked style="width: 16px; height: 16px; cursor: pointer;">
                            <span class="tooltip-hint" data-hint="When enabled, top_p and repetition_penalty auto-adjust based on temperature for optimal results">
                                üîÑ Auto-adjust top_p & repetition_penalty
                            </span>
                        </label>
                        <p style="font-size: 10px; color: #92400e; margin: 6px 0 0 24px; font-style: italic; line-height: 1.3;">
                            Recommended: Keep enabled for balanced behavior
                        </p>
                    </div>

                    <!-- Sampling Parameters -->
                    <div style="background: rgba(255, 255, 255, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <h5 style="font-size: 12px; color: #0c4a6e; margin: 0 0 12px 0;">üéØ Sampling Parameters</h5>

                        <!-- Top-P -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <label style="font-size: 11px; font-weight: bold; color: #0c4a6e;">
                                    <span class="tooltip-hint" data-hint="Nucleus sampling: Samples from smallest set of tokens whose cumulative probability exceeds P. Lower = more focused, higher = more diverse">
                                        Top-P (Nucleus Sampling)
                                    </span>
                                </label>
                                <span id="topPValue" style="font-size: 11px; color: #075985; font-family: monospace;">0.9</span>
                            </div>
                            <input type="range" id="topPSlider" min="0.1" max="1.0" step="0.05" value="0.9"
                                style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #3b82f6 0%, #10b981 100%); outline: none; -webkit-appearance: none;">
                            <div style="display: flex; justify-content: space-between; font-size: 9px; color: #64748b; margin-top: 4px;">
                                <span>Focused (0.1)</span>
                                <span>Balanced (0.5)</span>
                                <span>Diverse (1.0)</span>
                            </div>
                            <p style="font-size: 9px; color: #475569; margin-top: 4px; font-style: italic;">
                                Example: 0.9 = consider top 90% probability mass
                            </p>
                        </div>

                        <!-- Top-K -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <label style="font-size: 11px; font-weight: bold; color: #0c4a6e;">
                                    <span class="tooltip-hint" data-hint="Samples from top K most likely tokens. 0 = disabled. Lower = more predictable, higher = more random">
                                        Top-K (Top-K Sampling)
                                    </span>
                                </label>
                                <span id="topKValue" style="font-size: 11px; color: #075985; font-family: monospace;">0 (disabled)</span>
                            </div>
                            <input type="range" id="topKSlider" min="0" max="100" step="5" value="0"
                                style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #6b7280 0%, #3b82f6 100%); outline: none; -webkit-appearance: none;">
                            <div style="display: flex; justify-content: space-between; font-size: 9px; color: #64748b; margin-top: 4px;">
                                <span>Disabled (0)</span>
                                <span>Moderate (50)</span>
                                <span>Permissive (100)</span>
                            </div>
                            <p style="font-size: 9px; color: #475569; margin-top: 4px; font-style: italic;">
                                Example: 50 = pick from top 50 tokens only
                            </p>
                        </div>
                    </div>

                    <!-- Penalty Parameters -->
                    <div style="background: rgba(255, 255, 255, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <h5 style="font-size: 12px; color: #0c4a6e; margin: 0 0 12px 0;">üìä Penalty Parameters</h5>

                        <!-- Frequency Penalty -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <label style="font-size: 11px; font-weight: bold; color: #0c4a6e;">
                                    <span class="tooltip-hint" data-hint="Discourages repeating the same words based on their frequency. Higher = more variety">
                                        Frequency Penalty
                                    </span>
                                </label>
                                <span id="freqPenaltyValue" style="font-size: 11px; color: #075985; font-family: monospace;">0.3</span>
                            </div>
                            <input type="range" id="freqPenaltySlider" min="0.0" max="2.0" step="0.1" value="0.3"
                                style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%); outline: none; -webkit-appearance: none;">
                            <div style="display: flex; justify-content: space-between; font-size: 9px; color: #64748b; margin-top: 4px;">
                                <span>None (0.0)</span>
                                <span>Moderate (1.0)</span>
                                <span>Strong (2.0)</span>
                            </div>
                            <p style="font-size: 9px; color: #475569; margin-top: 4px; font-style: italic;">
                                0.0: "cats cats cats" | 0.5: "cats, felines, kitties"
                            </p>
                        </div>

                        <!-- Presence Penalty -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <label style="font-size: 11px; font-weight: bold; color: #0c4a6e;">
                                    <span class="tooltip-hint" data-hint="Encourages using new vocabulary. Penalizes tokens that already appear regardless of frequency">
                                        Presence Penalty
                                    </span>
                                </label>
                                <span id="presPenaltyValue" style="font-size: 11px; color: #075985; font-family: monospace;">0.0</span>
                            </div>
                            <input type="range" id="presPenaltySlider" min="0.0" max="2.0" step="0.1" value="0.0"
                                style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%); outline: none; -webkit-appearance: none;">
                            <div style="display: flex; justify-content: space-between; font-size: 9px; color: #64748b; margin-top: 4px;">
                                <span>None (0.0)</span>
                                <span>Moderate (1.0)</span>
                                <span>Strong (2.0)</span>
                            </div>
                            <p style="font-size: 9px; color: #475569; margin-top: 4px; font-style: italic;">
                                0.5: Uses new words after first appearance
                            </p>
                        </div>

                        <!-- Repetition Penalty -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <label style="font-size: 11px; font-weight: bold; color: #0c4a6e;">
                                    <span class="tooltip-hint" data-hint="MLC-specific: Penalizes all repeated tokens. Higher = less repetition but may reduce coherence">
                                        Repetition Penalty (MLC)
                                    </span>
                                </label>
                                <span id="repPenaltyValue" style="font-size: 11px; color: #075985; font-family: monospace;">1.15</span>
                            </div>
                            <input type="range" id="repPenaltySlider" min="1.0" max="2.0" step="0.05" value="1.15"
                                style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #10b981 0%, #f59e0b 50%, #ef4444 100%); outline: none; -webkit-appearance: none;">
                            <div style="display: flex; justify-content: space-between; font-size: 9px; color: #64748b; margin-top: 4px;">
                                <span>None (1.0)</span>
                                <span>Moderate (1.3)</span>
                                <span>Strong (2.0)</span>
                            </div>
                            <p style="font-size: 9px; color: #475569; margin-top: 4px; font-style: italic;">
                                Recommended: 1.1-1.3 for TinyLlama
                            </p>
                        </div>
                    </div>

                    <!-- Output Length -->
                    <div style="background: rgba(255, 255, 255, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <h5 style="font-size: 12px; color: #0c4a6e; margin: 0 0 12px 0;">üìè Output Length</h5>

                        <div style="margin-bottom: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <label style="font-size: 11px; font-weight: bold; color: #0c4a6e;">
                                    <span class="tooltip-hint" data-hint="Maximum number of tokens (words/subwords) in response. Higher = longer but slower">
                                        Max Tokens
                                    </span>
                                </label>
                                <span id="maxTokensValue" style="font-size: 11px; color: #075985; font-family: monospace;">300</span>
                            </div>
                            <input type="range" id="maxTokensSlider" min="50" max="1000" step="50" value="300"
                                style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%); outline: none; -webkit-appearance: none;">
                            <div style="display: flex; justify-content: space-between; font-size: 9px; color: #64748b; margin-top: 4px;">
                                <span>Short (50)</span>
                                <span>Medium (300)</span>
                                <span>Long (1000)</span>
                            </div>
                            <p style="font-size: 9px; color: #475569; margin-top: 4px; font-style: italic;">
                                ~75 tokens ‚âà 100 words. Higher values = slower responses
                            </p>
                        </div>
                    </div>

                    <!-- Advanced -->
                    <div style="background: rgba(255, 255, 255, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <h5 style="font-size: 12px; color: #0c4a6e; margin: 0 0 12px 0;">üé≤ Advanced</h5>

                        <div style="margin-bottom: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <label style="font-size: 11px; font-weight: bold; color: #0c4a6e;">
                                    <span class="tooltip-hint" data-hint="Random seed for reproducible outputs. Leave empty for random behavior. Same seed + params = identical outputs">
                                        Random Seed
                                    </span>
                                </label>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <input type="number" id="seedInput" placeholder="None (random)"
                                    style="flex: 1; padding: 6px 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 11px; font-family: monospace;">
                                <button id="useTimestampBtn" style="padding: 6px 12px; background: #0284c7; color: white; border: none; border-radius: 6px; font-size: 10px; cursor: pointer; white-space: nowrap;">
                                    Use Timestamp
                                </button>
                            </div>
                            <p style="font-size: 9px; color: #475569; margin-top: 4px; font-style: italic;">
                                For reproducible outputs (same seed = same response)
                            </p>
                        </div>
                    </div>

                    <!-- Reset and Presets -->
                    <div style="display: flex; gap: 8px; margin-top: 15px;">
                        <button id="resetExperimentalBtn" class="action-btn" style="flex: 1; background: #6b7280; color: white; font-size: 11px; padding: 8px;">
                            üîÑ Reset All
                        </button>
                        <button id="presetDeterministicBtn" class="action-btn" style="flex: 1; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-size: 11px; padding: 8px;">
                            üéØ Deterministic
                        </button>
                        <button id="presetCreativeBtn" class="action-btn" style="flex: 1; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-size: 11px; padding: 8px;">
                            üé® Creative
                        </button>
                    </div>
                </div>
            </div>

            <div class="drop-zone" id="dropZone">
                üìÇ Drop training file here or click to upload
                <input type="file" id="fileInput" accept=".json,.jsonl">
            </div>
        </div>
    </div>

    <!-- Support Dialog -->
    <div class="support-dialog" id="supportDialog">
        <div class="dialog-header">
            <h3>üê± Cat AI Support</h3>
            <button class="close-btn" id="closeBtn">√ó</button>
        </div>
        <div class="dialog-content">
            <div class="cat-image-container" id="catImageContainer">
                <div class="loading">Loading cat...</div>
            </div>
            <div class="model-selector-container">
                <label class="model-selector-label">Select AI Model:</label>
                <select class="model-selector" id="modelSelector">
                    <option value="tinyllama">TinyLlama 1.1B (Fast, ~600MB)</option>
                    <option value="qwen3-4b">Qwen3-4B-Thinking (Reasoning, ~2GB)</option>
                </select>
                <div class="model-info" id="modelInfo">Tiny & fast - great for quick responses</div>
                <button class="send-btn" id="loadModelBtn" style="margin-top: 8px; width: 100%;">Load Model</button>
            </div>
            <div class="model-status" id="modelStatus">
                Initializing AI... ‚è≥
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Ask the cat anything..." disabled>
                <button class="send-btn" id="sendBtn" disabled>Send</button>
            </div>
        </div>
    </div>

    <!-- Database Viewer Modal -->
    <div class="debug-modal" id="databaseModal" style="display: none;">
        <div class="debug-modal-content" style="max-width: 90%; max-height: 90%; overflow: auto;">
            <div class="dialog-header">
                <h3>üìä Knowledge Database</h3>
                <button class="close-btn" id="closeDatabaseBtn">√ó</button>
            </div>
            <div id="databaseContent" style="padding: 20px; max-height: 70vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Enrichment Review Modal -->
    <div class="debug-modal" id="enrichmentModal" style="display: none;">
        <div class="debug-modal-content" style="max-width: 800px; max-height: 90%; overflow: auto;">
            <div class="dialog-header">
                <h3>‚ú® Review Enrichments</h3>
                <button class="close-btn" id="closeEnrichmentBtn">√ó</button>
            </div>
            <div id="enrichmentContent" style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 32px; margin-bottom: 10px;">‚ú®</div>
                    <p>Generating variations...</p>
                </div>
            </div>
            <div style="padding: 15px 20px; border-top: 1px solid #e5e7eb; background: #f9fafb; display: flex; justify-content: flex-end; gap: 10px;">
                <button id="cancelEnrichmentBtn" class="action-btn" style="background: #6b7280; color: white; padding: 10px 20px;">
                    Cancel
                </button>
                <button id="saveEnrichmentsBtn" class="action-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 20px;">
                    üíæ Save Selected
                </button>
            </div>
        </div>
    </div>

    <!-- RAG Inspector Panel -->
    <div id="ragInspector" style="display: none; position: fixed; bottom: 60px; right: 20px; width: 500px; max-height: 400px; background: rgba(255, 255, 255, 0.98); border: 2px solid #8b5cf6; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 9999; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
            <span>üîç RAG Search Inspector</span>
            <button id="closeRAGInspectorBtn" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; line-height: 1;">√ó</button>
        </div>
        <div id="ragInspectorContent" style="padding: 15px; max-height: 340px; overflow-y: auto; font-size: 11px; font-family: monospace; white-space: pre-wrap; line-height: 1.4;"></div>
    </div>

    <!-- Console Log Viewer Panel -->
    <div id="consoleViewer" style="display: none; position: fixed; bottom: 60px; left: 20px; width: 600px; max-height: 400px; background: rgba(0, 0, 0, 0.95); border: 2px solid #10b981; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); z-index: 9999; overflow: hidden;">
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
            <span>üìú Console Logs</span>
            <div>
                <button id="clearConsoleBtn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 10px; cursor: pointer; padding: 4px 8px; margin-right: 8px; border-radius: 4px;">Clear</button>
                <button id="closeConsoleBtn" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0; line-height: 1;">√ó</button>
            </div>
        </div>
        <div id="consoleContent" style="padding: 10px; max-height: 340px; overflow-y: auto; font-size: 11px; font-family: 'Courier New', monospace; color: #10b981; line-height: 1.4;"></div>
    </div>

    <script type="module">
        // Generate random stars
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 100; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 3 + 's';
            starsContainer.appendChild(star);
        }

        // Import WebLLM and Transformers.js
        const webllm = await import('https://esm.run/@mlc-ai/web-llm');

        // Import JSZip for training package export
        const JSZip = (await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm')).default;

        // Import js-yaml for config export
        const jsyaml = await import('https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/+esm');

        // Import PouchDB for advanced RAG database with Mango queries
        const PouchDBModule = await import('https://cdn.jsdelivr.net/npm/pouchdb@8.0.1/+esm');
        const PouchDB = PouchDBModule.default;

        // Import PouchDB-Find plugin for Mango queries (createIndex, find)
        const PouchDBFindModule = await import('https://cdn.jsdelivr.net/npm/pouchdb-find@8.0.1/+esm');
        const PouchDBFind = PouchDBFindModule.default;

        // Add the find plugin to PouchDB
        PouchDB.plugin(PouchDBFind);
        console.log('üì¶ PouchDB loaded with Find plugin');

        // Import Transformers.js for semantic embeddings
        let transformers = null;
        let embeddingPipeline = null;
        let embeddingsReady = false;

        async function initEmbeddings() {
            try {
                console.log('üß† Loading Transformers.js...');
                transformers = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2');

                // Use all-MiniLM-L6-v2 - 384 dimensions, 80MB, fast
                console.log('üì• Loading embedding model (all-MiniLM-L6-v2)...');
                embeddingPipeline = await transformers.pipeline(
                    'feature-extraction',
                    'Xenova/all-MiniLM-L6-v2'
                );

                embeddingsReady = true;
                console.log('‚úÖ Semantic embeddings ready!');
                showLearningNotification('üß† Semantic search enabled!');

                // Update model status if already loaded
                if (engine && modelStatus) {
                    modelStatus.textContent = '‚úÖ AI Ready with Semantic Search! üß†üöÄ';
                }

                // Backfill embeddings if DB is already loaded
                if (learningDB) {
                    backfillEmbeddings();
                }
            } catch (error) {
                console.error('‚ö†Ô∏è Failed to load embeddings:', error);
                console.log('Falling back to keyword search');
            }
        }

        // Generate embedding for text
        async function generateEmbedding(text) {
            if (!embeddingsReady || !embeddingPipeline) {
                return null; // Fallback to keyword search
            }

            try {
                const output = await embeddingPipeline(text, {
                    pooling: 'mean',
                    normalize: true
                });

                // Convert to Float32Array
                return new Float32Array(output.data);
            } catch (error) {
                console.error('Error generating embedding:', error);
                return null;
            }
        }

        // Cosine similarity between two vectors
        function cosineSimilarity(vecA, vecB) {
            if (!vecA || !vecB || vecA.length !== vecB.length) {
                return 0;
            }

            let dotProduct = 0;
            let normA = 0;
            let normB = 0;

            for (let i = 0; i < vecA.length; i++) {
                dotProduct += vecA[i] * vecB[i];
                normA += vecA[i] * vecA[i];
                normB += vecB[i] * vecB[i];
            }

            if (normA === 0 || normB === 0) return 0;

            return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }

        // Backfill embeddings for existing data
        async function backfillEmbeddings() {
            if (!embeddingsReady || !learningDB) return;

            try {
                const result = await learningDB.allDocs({ include_docs: true });
                const allPairs = result.rows
                    .map(row => row.doc)
                    .filter(doc => doc.type === 'question-answer');

                let backfilled = 0;
                for (const pair of allPairs) {
                    // Only generate if missing
                    if (!pair.embedding) {
                        const embedding = await generateEmbedding(pair.question);
                        if (embedding) {
                            pair.embedding = Array.from(embedding);

                            // Update the document in PouchDB
                            await learningDB.put(pair);

                            backfilled++;
                        }
                    }
                }

                if (backfilled > 0) {
                    console.log(`‚úÖ Backfilled ${backfilled} embeddings for existing data`);
                    showLearningNotification(`üß† Generated embeddings for ${backfilled} existing examples!`);
                } else {
                    console.log('‚ÑπÔ∏è All existing data already has embeddings');
                }
            } catch (error) {
                console.error('Error backfilling embeddings:', error);
            }
        }

        // Start loading embeddings in background
        initEmbeddings();

        // DOM elements
        const chatBubble = document.getElementById('chatBubble');
        const supportDialog = document.getElementById('supportDialog');
        const closeBtn = document.getElementById('closeBtn');
        const catImageContainer = document.getElementById('catImageContainer');
        const modelStatus = document.getElementById('modelStatus');
        const progressFill = document.getElementById('progressFill');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const modelSelector = document.getElementById('modelSelector');
        const modelInfo = document.getElementById('modelInfo');
        const loadModelBtn = document.getElementById('loadModelBtn');

        // Model configurations
        const MODEL_CONFIGS = {
            'tinyllama': {
                name: 'TinyLlama 1.1B',
                f16: 'TinyLlama-1.1B-Chat-v0.4-q4f16_1-MLC',
                f32: 'TinyLlama-1.1B-Chat-v0.4-q4f32_1-MLC',
                size: '~600MB',
                description: 'Tiny & fast - great for quick responses',
                requiresCustomConfig: false
            },
            'qwen3-4b': {
                name: 'Qwen3-4B-Thinking',
                f16: 'Qwen3-4B-Thinking-2507-q4f32_1-MLC',
                f32: 'Qwen3-4B-Thinking-2507-q4f32_1-MLC',
                size: '~2GB',
                description: 'Reasoning model üß† (requires 8GB+ VRAM)',
                requiresCustomConfig: true,
                customConfig: {
                    model: "https://huggingface.co/vladbuinceanu/Qwen3-4B-Thinking-2507-q4f32_1-MLC",
                    model_id: "Qwen3-4B-Thinking-2507-q4f32_1-MLC",
                    model_lib_suffix: '/Qwen3-4B-q4f32_1-ctx4k_cs1k-webgpu.wasm',
                    context_window_size: 4096
                }
            }
        };

        // Current selected model
        let selectedModel = 'tinyllama';

        // Update model info when selection changes
        modelSelector.addEventListener('change', function() {
            selectedModel = this.value;
            const config = MODEL_CONFIGS[selectedModel];
            modelInfo.textContent = config.description;

            // If model is already loaded, warn about page reload needed
            if (engine) {
                modelStatus.textContent = `‚ö†Ô∏è Page reload required to switch models (GPU memory)`;
                loadModelBtn.textContent = 'Reload Page to Switch';
                loadModelBtn.onclick = () => {
                    // Save selected model to localStorage before reload
                    localStorage.setItem('selectedModel', selectedModel);
                    location.reload();
                };
            }
        });

        // Load model button click handler
        loadModelBtn.addEventListener('click', async function() {
            if (engine) {
                // If model already loaded, need page reload
                localStorage.setItem('selectedModel', selectedModel);
                location.reload();
                return;
            }

            loadModelBtn.disabled = true;
            loadModelBtn.textContent = 'Loading...';
            await initializeModel();
            loadModelBtn.style.display = 'none';
        });

        // Restore selected model from localStorage (after page reload)
        const savedModel = localStorage.getItem('selectedModel');
        if (savedModel && MODEL_CONFIGS[savedModel]) {
            selectedModel = savedModel;
            modelSelector.value = savedModel;
            modelInfo.textContent = MODEL_CONFIGS[savedModel].description;
            localStorage.removeItem('selectedModel'); // Clear after use
        }

        // LLM state
        let engine = null;
        let isGenerating = false;
        let conversationHistory = [];

        // Learning database state (PouchDB)
        let learningDB = null;
        const DB_NAME = 'cats_rag'; // PouchDB database name

        // Current system prompt for RLHF tracking
        // Default system prompt
        const DEFAULT_SYSTEM_PROMPT = "CRITICAL: You MUST answer in English ONLY. Never use German or any other language.\n\nYou are a helpful, friendly cat AI assistant who lives on the moon. Keep responses concise, fun, and informative.";

        let currentSystemPrompt = DEFAULT_SYSTEM_PROMPT;
        let lastRAGResults = [];

        // Advanced control settings
        let creativityLevel = 0.7;  // Default temperature
        let ragInfluence = 0.5;     // Default RAG influence (0-1 scale)
        let minRAGTemperature = 0.4; // Minimum temperature when RAG results exist (prevents ignoring context)

        // Experimental LLM Parameters
        let expTopP = 0.9;           // Nucleus sampling
        let expTopK = 0;             // Top-K sampling (0 = disabled)
        let expFrequencyPenalty = 0.3;  // Discourage repetition
        let expPresencePenalty = 0.0;   // Encourage diversity
        let expRepetitionPenalty = 1.15; // MLC-specific repetition penalty
        let expMaxTokens = 300;      // Maximum response length
        let expSeed = null;          // Random seed for reproducibility
        let autoAdjustParams = true; // Auto-adjust top_p and rep_penalty based on temperature

        // Starter knowledge - pre-seeded Q&A pairs for better initial experience
        const STARTER_KNOWLEDGE = [
            { q: "what are cats", a: "Cats are magnificent, independent creatures who rule the moon and occasionally tolerate humans! üê±" },
            { q: "tell me about cats", a: "Cats are superior beings with excellent napping skills and a natural talent for knocking things off tables!" },
            { q: "what is your name", a: "I'm Moon Cat, the AI assistant who lives on the moon! Meow! üåôüò∫" },
            { q: "who are you", a: "I'm a cat-powered AI running in your browser. I own the moon and love helping humans!" },
            { q: "what can you do", a: "I can chat about anything, answer questions, and share my cat wisdom! Plus, I'm learning from our conversations!" },
            { q: "how do you work", a: "I'm powered by TinyLlama 1.1B AI model running in your browser with WebGPU acceleration. I'm tiny, fast, and learn from your feedback! ‚ú®" },
            { q: "do you like the moon", a: "The moon belongs to cats! It's the perfect place - quiet, peaceful, and excellent for naps! üåô" },
            { q: "why cats on the moon", a: "Because cats are naturally drawn to high places, and the moon is the highest place of all! Plus, excellent bird watching. üò∫" },
            { q: "what do you think about dogs", a: "Dogs are fine... I suppose. They're very enthusiastic. A bit too enthusiastic if you ask me! üêï" },
            { q: "can you help me", a: "Of course! That's what I'm here for. Ask me anything and I'll do my best to assist! üêæ" },
            { q: "are you smart", a: "I'm as smart as you help me become! The more you teach me with üëç and üëé, the better I get!" },
            { q: "thank you", a: "You're welcome! Happy to help, fellow moon explorer! üåô‚ú®" },

            // üéØ PHASE 2 DEMO: Q&A with DOM actions!
            {
                q: "show me the training panel",
                a: "Opening the training panel for you! Here you can export your knowledge base for fine-tuning. üöÄ",
                domActions: [
                    {
                        type: 'show-panel',
                        panel: 'trainingPanel',
                        trigger: 'on-answer-shown',
                        permission: 'allowed',
                        delay: 300
                    }
                ]
            },
            {
                q: "make it more creative",
                a: "Setting creativity to maximum! Your responses will now be more imaginative and varied. ‚ú®",
                domActions: [
                    {
                        type: 'set-creativity',
                        value: 1.2,
                        trigger: 'on-answer-shown',
                        permission: 'allowed'
                    },
                    {
                        type: 'notify',
                        message: 'üé® Creativity set to 1.2!',
                        trigger: 'on-answer-shown',
                        permission: 'allowed',
                        delay: 500
                    }
                ]
            },
            {
                q: "add more stars",
                a: "Adding some extra stars to make our moon even more beautiful! ‚ú®üåü",
                domActions: [
                    {
                        type: 'add-stars',
                        count: 30,
                        trigger: 'on-answer-shown',
                        permission: 'allowed',
                        delay: 200
                    }
                ]
            }
        ];

        // Initialize PouchDB for learning with advanced querying
        async function initLearningDB() {
            try {
                // Create PouchDB instance
                learningDB = new PouchDB(DB_NAME);
                console.log('üìö PouchDB Learning database initialized!');

                // Create indexes for Mango queries (optimized for fast filtering)
                await learningDB.createIndex({
                    index: {
                        fields: ['type', 'rating', 'category', 'timestamp'],
                        name: 'main-query-index'
                    }
                });

                await learningDB.createIndex({
                    index: {
                        fields: ['tags'],
                        name: 'tags-index'
                    }
                });

                await learningDB.createIndex({
                    index: {
                        fields: ['type', 'timestamp'],
                        name: 'type-time-index'
                    }
                });

                console.log('üìä Indexes created for fast Mango queries!');

                // Seed with starter knowledge if database is empty
                await seedStarterKnowledge();

                return learningDB;
            } catch (error) {
                console.error('‚ùå Failed to initialize PouchDB:', error);
                throw error;
            }
        }

        // Auto-generate tags from question and answer
        function autoGenerateTags(question, answer, category) {
            const tags = new Set();

            // Always add type tag
            tags.add('question-answer');

            // Add category as tag
            if (category) {
                tags.add(category);
            }

            // Extract tags from question
            const q = question.toLowerCase();
            const a = answer.toLowerCase();

            // UI-related tags
            if (q.match(/dark|light|theme|color|background/)) tags.add('ui-theme');
            if (q.match(/panel|show|hide|display/)) tags.add('ui-control');
            if (q.match(/setting|config|preference/)) tags.add('settings');

            // Technical tags
            if (q.match(/how.*work|explain|technical|api|code/)) tags.add('technical');
            if (q.match(/rag|retrieval|search|semantic/)) tags.add('rag');
            if (q.match(/llm|model|ai|parameter/)) tags.add('ai');
            if (q.match(/temperature|creativity|top.?p|sampling/)) tags.add('llm-parameters');

            // Cat/Moon theme tags
            if (q.match(/cat|kitten|feline|meow|purr/) || a.match(/cat|kitten|meow/)) tags.add('cats');
            if (q.match(/moon|lunar|space|star/) || a.match(/moon|lunar|space/)) tags.add('moon');

            // Support/Help tags
            if (q.match(/help|assist|support|how to/)) tags.add('help');
            if (q.match(/thank|appreciate/) || a.match(/welcome|pleasure/)) tags.add('gratitude');
            if (q.match(/hello|hi|hey|greet/)) tags.add('greeting');

            // Identity tags
            if (q.match(/who.*you|what.*you|your name/)) tags.add('identity');

            // Learning/Training tags
            if (q.match(/learn|train|feedback|improve/)) tags.add('learning');
            if (q.match(/rlhf|dpo|fine.?tun/)) tags.add('training');

            return Array.from(tags);
        }

        // Get current DOM state
        function getCurrentDOMState() {
            return {
                background_color: getComputedStyle(document.body).background,
                moon_visible: document.querySelector('.moon') ? true : false,
                stars_count: document.querySelectorAll('.star').length,
                theme: document.body.dataset.theme || 'default'
            };
        }

        // Seed database with starter knowledge
        async function seedStarterKnowledge() {
            const stats = await getLearningStats();

            // Only seed if database is empty
            if (stats.total === 0) {
                console.log('üå± Seeding database with starter knowledge...');

                for (const item of STARTER_KNOWLEDGE) {
                    await saveQAPair(item.q, item.a, 'up', {
                        domActions: item.domActions || []
                    });
                }

                const newStats = await getLearningStats();
                console.log(`‚úÖ Loaded ${newStats.liked} starter Q&A pairs!`);
                showLearningNotification(`üå± Initialized with ${newStats.liked} starter examples!`);
            }
        }

        // Save Q&A pair to learning database with RLHF/DPO data
        async function saveQAPair(question, answer, rating = null, metadata = {}) {
            if (!learningDB) await initLearningDB();

            // Generate embedding for semantic search
            const embedding = await generateEmbedding(question);

            // Capture DOM state
            const domState = getCurrentDOMState();

            // Detect category
            const category = detectCategory(question);

            // Auto-generate tags
            const tags = metadata.tags || autoGenerateTags(question, answer, category);

            const timestamp = Date.now();
            const doc = {
                _id: `qa_${timestamp}_${Math.random().toString(36).substr(2, 9)}`,
                type: 'question-answer',

                // Core Q&A
                question: question.toLowerCase(),
                answer: answer,
                rating: rating,
                timestamp: timestamp,

                // NEW: Tags for multi-dimensional categorization
                tags: tags,
                category: category,

                // RLHF/DPO fields
                conversation_context: metadata.conversation_context || [...conversationHistory],
                system_prompt: metadata.system_prompt || currentSystemPrompt,
                rag_context: metadata.rag_context || [...lastRAGResults],
                dom_state: metadata.dom_state || domState,
                model_version: metadata.model_version || "TinyLlama-1.1B-Chat-v0.4-q4f16_1-MLC",
                inference_params: metadata.inference_params || {
                    temperature: creativityLevel,
                    top_p: expTopP,
                    top_k: expTopK,
                    max_tokens: expMaxTokens,
                    repetition_penalty: expRepetitionPenalty,
                    frequency_penalty: expFrequencyPenalty,
                    presence_penalty: expPresencePenalty
                },
                alternative_answers: metadata.alternative_answers || [],
                response_time_ms: metadata.response_time || 0,

                // Semantic embedding (384-dim vector as array for PouchDB)
                embedding: embedding ? Array.from(embedding) : null,

                // NEW: Placeholder for future DOM actions
                domActions: metadata.domActions || []
            };

            try {
                const result = await learningDB.put(doc);
                console.log(`‚úÖ Saved Q&A with tags: ${tags.join(', ')}`);
                return result.id;
            } catch (error) {
                console.error('‚ùå Failed to save Q&A:', error);
                throw error;
            }
        }

        // Find similar questions using keyword matching
        async function findSimilarQuestions(question, limit = 3) {
            if (!learningDB) await initLearningDB();

            try {
                const result = await learningDB.allDocs({ include_docs: true });
                const allPairs = result.rows
                    .map(row => row.doc)
                    .filter(doc => doc.type === 'question-answer');

                // Simple keyword-based similarity
                const questionWords = question.toLowerCase().split(/\s+/);
                const scored = allPairs.map(pair => {
                    const pairWords = pair.question.split(/\s+/);
                    const commonWords = questionWords.filter(w => pairWords.includes(w)).length;
                    const similarity = commonWords / Math.max(questionWords.length, pairWords.length);
                    return { ...pair, similarity };
                });

                // Sort by similarity and rating, filter out low similarity
                const similar = scored
                    .filter(p => p.similarity > 0.2 && p.rating === 'up')
                    .sort((a, b) => {
                        // Prefer higher similarity and positive ratings
                        if (b.similarity !== a.similarity) return b.similarity - a.similarity;
                        return (b.rating === 'up' ? 1 : 0) - (a.rating === 'up' ? 1 : 0);
                    })
                    .slice(0, limit);

                return similar;
            } catch (error) {
                console.error('Error finding similar questions:', error);
                return [];
            }
        }

        // Get learning statistics
        async function getLearningStats() {
            if (!learningDB) await initLearningDB();

            try {
                const result = await learningDB.allDocs({ include_docs: true });
                const pairs = result.rows
                    .map(row => row.doc)
                    .filter(doc => doc.type === 'question-answer');

                const stats = {
                    total: pairs.length,
                    star1: pairs.filter(p => p.rating === 'star1').length,
                    star2: pairs.filter(p => p.rating === 'star2').length,
                    star3: pairs.filter(p => p.rating === 'star3').length,
                    liked: pairs.filter(p => p.rating === 'up' || p.rating === 'star1' || p.rating === 'star2' || p.rating === 'star3').length,
                    disliked: pairs.filter(p => p.rating === 'down').length,
                    // Legacy 'up' support
                    legacyUp: pairs.filter(p => p.rating === 'up').length
                };
                return stats;
            } catch (error) {
                console.error('‚ùå Failed to get learning stats:', error);
                return {
                    total: 0,
                    star1: 0,
                    star2: 0,
                    star3: 0,
                    liked: 0,
                    disliked: 0,
                    legacyUp: 0
                };
            }
        }

        // Show learning notification
        function showLearningNotification(message) {
            const badge = document.createElement('div');
            badge.className = 'learning-badge';
            badge.textContent = message;
            document.body.appendChild(badge);

            setTimeout(() => {
                badge.remove();
            }, 3000);
        }

        // Check WebGPU support and features
        async function checkWebGPU() {
            if (!navigator.gpu) {
                return { available: false, hasF16: false };
            }
            try {
                const adapter = await navigator.gpu.requestAdapter();
                if (!adapter) {
                    return { available: false, hasF16: false };
                }

                // Check for shader-f16 support (optional, fallback to f32 if not available)
                const hasF16 = adapter.features.has('shader-f16');

                return { available: true, hasF16: hasF16 };
            } catch {
                return { available: false, hasF16: false };
            }
        }

        // Function to load a random cat from CATAAS
        function loadRandomCat() {
            catImageContainer.innerHTML = '<div class="loading">Loading cat...</div>';
            const img = document.createElement('img');
            img.className = 'cat-image';
            const timestamp = new Date().getTime();
            img.src = `https://cataas.com/cat?timestamp=${timestamp}`;
            img.onload = function() {
                catImageContainer.innerHTML = '';
                catImageContainer.appendChild(img);
            };
            img.onerror = function() {
                catImageContainer.innerHTML = '<div class="loading">üò∫</div>';
            };
        }

        // Parse thinking blocks from response
        function parseThinkingBlocks(content) {
            const thinkRegex = /<think>([\s\S]*?)<\/think>/g;
            const thoughts = [];
            let match;

            while ((match = thinkRegex.exec(content)) !== null) {
                thoughts.push(match[1].trim());
            }

            // Remove thinking blocks from main content
            const cleanContent = content.replace(thinkRegex, '').trim();

            return { thoughts, cleanContent };
        }

        // Add message to chat
        function addMessage(content, role, questionContext = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            // Parse thinking blocks for assistant messages
            let thoughts = [];
            let displayContent = content;

            if (role === 'assistant') {
                const parsed = parseThinkingBlocks(content);
                thoughts = parsed.thoughts;
                displayContent = parsed.cleanContent;
            }

            // For assistant messages with ratings, wrap content in a div
            if (role === 'assistant' && questionContext) {
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'message-content';
                contentWrapper.textContent = displayContent;

                // Add thinking blocks if present
                if (thoughts.length > 0) {
                    thoughts.forEach(thought => {
                        const thinkDiv = document.createElement('div');
                        thinkDiv.className = 'thinking-block';

                        const thinkContent = document.createElement('div');
                        thinkContent.className = 'thinking-content';
                        thinkContent.textContent = thought;

                        thinkDiv.appendChild(thinkContent);

                        // Insert before the content
                        contentWrapper.insertBefore(thinkDiv, contentWrapper.firstChild);
                    });
                }

                messageDiv.appendChild(contentWrapper);
            } else {
                // For user messages and assistant messages without ratings
                messageDiv.textContent = displayContent;

                // Add thinking blocks if present
                if (thoughts.length > 0) {
                    thoughts.forEach(thought => {
                        const thinkDiv = document.createElement('div');
                        thinkDiv.className = 'thinking-block';

                        const thinkContent = document.createElement('div');
                        thinkContent.className = 'thinking-content';
                        thinkContent.textContent = thought;

                        thinkDiv.appendChild(thinkContent);

                        // Insert before the text content
                        messageDiv.insertBefore(thinkDiv, messageDiv.firstChild);
                    });
                }
            }

            // Add rating buttons for assistant messages (STAR RATING SYSTEM)
            if (role === 'assistant' && questionContext) {
                const ratingDiv = document.createElement('div');
                ratingDiv.className = 'message-rating';

                // Helper to clear all active states
                const clearActive = () => {
                    ratingDiv.querySelectorAll('.rating-btn').forEach(btn => btn.classList.remove('active'));
                };

                // Star 1 - Okay
                const star1 = document.createElement('button');
                star1.className = 'rating-btn';
                star1.innerHTML = '‚≠ê';
                star1.title = 'Okay answer (0.8√ó weight)';
                star1.onclick = async () => {
                    clearActive();
                    star1.classList.add('active');
                    await saveQAPair(questionContext, displayContent, 'star1');
                    const stats = await getLearningStats();
                    showLearningNotification(`‚≠ê Saved as okay (${stats.total} total)`);
                };

                // Star 2 - Good
                const star2 = document.createElement('button');
                star2.className = 'rating-btn';
                star2.innerHTML = '‚≠ê‚≠ê';
                star2.title = 'Good answer (1.0√ó weight)';
                star2.onclick = async () => {
                    clearActive();
                    star2.classList.add('active');
                    await saveQAPair(questionContext, displayContent, 'star2');
                    const stats = await getLearningStats();
                    showLearningNotification(`‚≠ê‚≠ê Saved as good! (${stats.total} total)`);
                };

                // Star 3 - Excellent
                const star3 = document.createElement('button');
                star3.className = 'rating-btn';
                star3.innerHTML = '‚≠ê‚≠ê‚≠ê';
                star3.title = 'Excellent answer (1.2√ó weight)';
                star3.onclick = async () => {
                    clearActive();
                    star3.classList.add('active');
                    await saveQAPair(questionContext, displayContent, 'star3');
                    const stats = await getLearningStats();
                    showLearningNotification(`‚ú® Saved as excellent! (${stats.total} total)`);
                };

                // Thumbs Down - Bad
                const thumbsDown = document.createElement('button');
                thumbsDown.className = 'rating-btn';
                thumbsDown.innerHTML = 'üëé';
                thumbsDown.title = 'Bad response (excluded from RAG)';
                thumbsDown.onclick = async () => {
                    clearActive();
                    thumbsDown.classList.add('active');
                    await saveQAPair(questionContext, displayContent, 'down');
                    showLearningNotification('üëé Noted. This will be excluded from search.');
                };

                // Enrich Button - Generate variations
                const enrichBtn = document.createElement('button');
                enrichBtn.className = 'rating-btn';
                enrichBtn.innerHTML = '‚ú®';
                enrichBtn.title = 'Generate Q&A variations';
                enrichBtn.style.marginLeft = '10px';
                enrichBtn.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
                enrichBtn.style.color = 'white';
                enrichBtn.onclick = async () => {
                    enrichBtn.disabled = true;
                    enrichBtn.innerHTML = '‚è≥';
                    try {
                        await generateAndShowEnrichments(questionContext, displayContent);
                    } finally {
                        enrichBtn.disabled = false;
                        enrichBtn.innerHTML = '‚ú®';
                    }
                };

                ratingDiv.appendChild(star1);
                ratingDiv.appendChild(star2);
                ratingDiv.appendChild(star3);
                ratingDiv.appendChild(thumbsDown);
                ratingDiv.appendChild(enrichBtn);
                messageDiv.appendChild(ratingDiv);
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Initialize the LLM model
        async function initializeModel() {
            try {
                // Get selected model config
                const config = MODEL_CONFIGS[selectedModel];

                // Check WebGPU support
                const gpuInfo = await checkWebGPU();

                if (!gpuInfo.available) {
                    modelStatus.textContent = '‚ö†Ô∏è WebGPU not available - model requires WebGPU';
                    addMessage('Note: Your browser doesn\'t support WebGPU. This model requires WebGPU. Please use Chrome/Edge 113+.', 'system');
                    return;
                }

                // Inform about shader-f16 support
                const modeStr = gpuInfo.hasF16 ? 'f16' : 'f32';
                if (!gpuInfo.hasF16) {
                    console.log('‚ÑπÔ∏è shader-f16 not available - model will use f32 fallback (still works, slightly slower)');
                    modelStatus.textContent = `Loading ${config.name} (${modeStr} mode)...`;
                    addMessage(`‚ú® WebGPU detected! Loading ${config.name} (using f32 fallback - works great on all GPUs)...`, 'system');
                } else {
                    console.log('‚úÖ shader-f16 available - optimal performance!');
                    modelStatus.textContent = `Loading ${config.name} (${modeStr} mode)...`;
                    addMessage(`‚ú® WebGPU detected! Loading ${config.name} with f16 acceleration - optimal performance!...`, 'system');
                }

                progressFill.style.width = '5%';

                // Select model variant based on f16 support
                const modelVariant = gpuInfo.hasF16 ? config.f16 : config.f32;
                console.log(`Loading model variant: ${modelVariant}`);

                // Check if model requires custom configuration (e.g., Qwen3-4B from HuggingFace)
                if (config.requiresCustomConfig && config.customConfig) {
                    // Custom model from HuggingFace with CDN .wasm
                    const appConfig = {
                        ...webllm.prebuiltAppConfig,
                        model_list: [
                            {
                                model: config.customConfig.model,
                                model_id: config.customConfig.model_id,
                                model_lib: webllm.modelLibURLPrefix + webllm.modelVersion + config.customConfig.model_lib_suffix,
                                overrides: { context_window_size: config.customConfig.context_window_size }
                            }
                        ]
                    };

                    engine = await webllm.CreateMLCEngine(
                        config.customConfig.model_id,
                        {
                            appConfig: appConfig,
                            initProgressCallback: (progress) => {
                                const percent = Math.round(progress.progress * 100);
                                progressFill.style.width = percent + '%';
                                modelStatus.textContent = progress.text || `Loading ${config.name}... ${percent}%`;
                                console.log('Progress:', progress);
                            }
                        }
                    );
                } else {
                    // Standard WebLLM model
                    engine = await webllm.CreateMLCEngine(
                        modelVariant,
                        {
                            initProgressCallback: (progress) => {
                                const percent = Math.round(progress.progress * 100);
                                progressFill.style.width = percent + '%';
                                modelStatus.textContent = progress.text || `Loading ${config.name}... ${percent}%`;
                                console.log('Progress:', progress);
                            }
                        }
                    );
                }

                progressFill.style.width = '100%';

                // Check if embeddings are ready
                if (embeddingsReady) {
                    modelStatus.textContent = `‚úÖ ${config.name} Ready with Semantic Search! üß†üöÄ`;
                } else {
                    modelStatus.textContent = `‚úÖ ${config.name} Ready! (Semantic search loading...) üöÄ`;
                }

                // Enable chat input
                chatInput.disabled = false;
                sendBtn.disabled = false;
                chatInput.focus();

                // Add welcome message
                let welcomeMsg = `Hello! I'm a cat-powered AI assistant running ${config.name}. What would you like to know? üê±`;
                if (selectedModel === 'qwen3-4b') {
                    welcomeMsg += '\n\nüß† I can show you my thinking process!';
                }
                if (!embeddingsReady) {
                    welcomeMsg += '\n\nüí° Tip: Semantic search is loading in the background (~30 seconds). Responses will improve once ready!';
                }
                addMessage(welcomeMsg, 'assistant');

            } catch (error) {
                console.error('Error loading model:', error);

                // Check for GPU out of memory errors
                const errorStr = error.toString().toLowerCase();
                if (errorStr.includes('memory') || errorStr.includes('gpu') || errorStr.includes('disposed')) {
                    modelStatus.textContent = '‚ùå GPU out of memory - try TinyLlama';
                    addMessage('‚ö†Ô∏è GPU out of memory! Your GPU doesn\'t have enough VRAM for this model.\n\n' +
                        '**Solution:** Reload the page and select TinyLlama 1.1B instead (works with 4GB+ VRAM).', 'system');

                    // Reset button for retry
                    loadModelBtn.disabled = false;
                    loadModelBtn.textContent = 'Reload & Try TinyLlama';
                    loadModelBtn.style.display = 'block';
                    loadModelBtn.onclick = () => {
                        localStorage.setItem('selectedModel', 'tinyllama');
                        location.reload();
                    };
                } else {
                    modelStatus.textContent = '‚ùå Failed to load AI model. Please refresh.';
                    addMessage('Sorry, I encountered an error loading the AI model. Please try refreshing the page.', 'system');
                }
            }
        }

        // Generate response from the model with RAG
        async function generateResponse(userMessage) {
            if (isGenerating || !engine) return;

            isGenerating = true;
            sendBtn.disabled = true;
            chatInput.disabled = true;

            try {
                // ========================================
                // RAG INFLUENCE CONTROL
                // ========================================
                let similarPairs = [];
                let ragSkipped = false;

                if (ragInfluence === 0) {
                    // Pure LLM mode - skip RAG entirely
                    console.log('üîÆ RAG INFLUENCE: 0.0 - Pure LLM mode (no database search)');
                    similarPairs = [];
                    ragSkipped = true;
                } else if (ragInfluence === 1.0) {
                    // RAG-only mode - return stored answer directly if good match exists
                    console.log('üìö RAG INFLUENCE: 1.0 - RAG-only mode (database-first)');
                    similarPairs = await findSimilarQuestionsEnhanced(userMessage, 1);

                    if (similarPairs.length > 0 && similarPairs[0].similarity > 0.7) {
                        // High confidence match - return directly
                        console.log(`‚úÖ High confidence match (${similarPairs[0].similarity.toFixed(3)}) - returning stored answer`);
                        addMessage(similarPairs[0].answer, 'assistant', userMessage);
                        conversationHistory.push({ role: 'user', content: userMessage });
                        conversationHistory.push({ role: 'assistant', content: similarPairs[0].answer });

                        // üéØ PHASE 2: Execute DOM actions for this answer
                        executeRAGDOMActions(similarPairs[0], 'on-answer-shown');

                        isGenerating = false;
                        sendBtn.disabled = false;
                        chatInput.disabled = false;
                        return;
                    } else {
                        // No good match in RAG-only mode
                        addMessage("I don't have information about that in my knowledge base. Try lowering RAG influence to let me generate an answer, or teach me by chatting!", 'assistant');
                        isGenerating = false;
                        sendBtn.disabled = false;
                        chatInput.disabled = false;
                        return;
                    }
                } else {
                    // Blended mode - scale RAG results by influence
                    const maxResults = Math.max(1, Math.ceil(ragInfluence * 10));
                    console.log(`üß† RAG INFLUENCE: ${ragInfluence.toFixed(1)} - Blended mode (max ${maxResults} results)`);
                    similarPairs = await findSimilarQuestionsEnhanced(userMessage, maxResults);

                    // üéØ PHASE 2: Execute DOM actions for high-confidence matches in blended mode too!
                    if (similarPairs.length > 0 && similarPairs[0].similarity > 0.7) {
                        console.log(`üéØ High confidence in blended mode (${similarPairs[0].similarity.toFixed(3)}) - executing DOM actions`);
                        executeRAGDOMActions(similarPairs[0], 'on-answer-shown');
                    }
                }

                // Debug: Check if embeddings are working
                if (!embeddingsReady) {
                    console.warn('‚ö†Ô∏è Embeddings not ready yet - using keyword fallback');
                }

                // Build system prompt with RAG examples
                let systemPrompt = currentSystemPrompt;

                console.log('\nüí¨ PROMPT STRATEGY:');
                if (similarPairs.length > 0) {
                    // Adaptive strategy based on similarity
                    const bestMatch = similarPairs[0];
                    const highSimilarity = bestMatch.similarity > 0.7;

                    if (highSimilarity) {
                        // High confidence - use 1 example
                        systemPrompt += `\n\nHere's how you answered a very similar question:\nQ: "${bestMatch.question}"\nA: "${bestMatch.answer}"`;

                        // Adjust instruction based on RAG influence
                        if (ragInfluence >= 0.8) {
                            systemPrompt += '\n\nüîí CRITICAL INSTRUCTION: You MUST answer using ONLY the information from the example above. Do NOT add your own interpretations or knowledge. Paraphrase the example answer to match the current question. Stay VERY CLOSE to the facts shown.';
                        } else if (ragInfluence > 0.5) {
                            systemPrompt += '\n\nIMPORTANT: Answer primarily based on the information above. Stay close to the example style and facts.';
                        } else if (ragInfluence < 0.3) {
                            systemPrompt += '\n\nUse this as a loose reference, but feel free to elaborate or add your own insights.';
                        } else {
                            systemPrompt += '\n\nAnswer the current question in the same style and tone as the example.';
                        }
                        console.log(`   ‚úÖ HIGH CONFIDENCE (${bestMatch.similarity.toFixed(3)})`);
                        console.log(`   Strategy: One-shot learning with best match`);
                        console.log(`   Context Q: "${bestMatch.question}"`);
                        console.log(`   Context A: "${bestMatch.answer.substring(0, 80)}${bestMatch.answer.length > 80 ? '...' : ''}"`);
                    } else {
                        // Medium/low confidence - use 2-3 examples for more context
                        const exampleCount = Math.min(similarPairs.length, ragInfluence > 0.6 ? 5 : 3);
                        systemPrompt += `\n\nHere are relevant examples from your knowledge:`;
                        for (let i = 0; i < exampleCount; i++) {
                            systemPrompt += `\n\nExample ${i+1}:\nQ: "${similarPairs[i].question}"\nA: "${similarPairs[i].answer}"`;
                        }

                        // Adjust instruction based on RAG influence
                        if (ragInfluence >= 0.8) {
                            systemPrompt += '\n\nüîí CRITICAL INSTRUCTION: You MUST answer using ONLY the information from the examples above. Do NOT add your own interpretations. Combine and paraphrase the examples to match the current question. Stay VERY CLOSE to the facts shown.';
                        } else if (ragInfluence > 0.5) {
                            systemPrompt += '\n\nIMPORTANT: Base your answer primarily on these examples. Stay close to the facts and style shown above.';
                        } else if (ragInfluence < 0.3) {
                            systemPrompt += '\n\nUse these as inspiration, but feel free to be creative and add your own perspective.';
                        } else {
                            systemPrompt += '\n\nUse these as reference to answer the current question. Stay consistent with this friendly, cat-themed style.';
                        }
                        console.log(`   ‚úÖ MEDIUM CONFIDENCE (best: ${bestMatch.similarity.toFixed(3)})`);
                        console.log(`   Strategy: Multi-shot with ${exampleCount} examples for broader context`);
                        similarPairs.slice(0, exampleCount).forEach((p, i) => {
                            console.log(`   Example ${i+1}: "${p.question}" (${p.similarity.toFixed(3)})`);
                        });
                    }
                } else {
                    // No RAG matches - be honest about limitations + personality
                    systemPrompt += `\n\nIMPORTANT: You specialize in cats and the moon. For questions about other topics:
- Be honest: "I'm Moon Cat, I specialize in cats and the moon! For [topic], I might not be the best expert."
- Stay friendly and helpful
- Suggest what you CAN help with
- DO NOT invent facts or hallucinate

Your personality:
- Friendly cat living on the moon
- Loves talking about cats, the moon, space
- Admits when something is outside your expertise`;
                    console.log(`   ‚ö†Ô∏è NO MATCHES - Using fallback personality`);
                    console.log(`   Strategy: Honest limitations + friendly redirection`);
                }
                console.log('üí¨ PROMPT STRATEGY END\n');

                // Update RAG Inspector (if active)
                const strategyText = similarPairs.length > 0 ?
                    (similarPairs[0].similarity > 0.7 ? 'High Confidence (One-shot)' : 'Medium Confidence (Multi-shot)') :
                    'No Matches (Fallback)';
                updateRAGInspector(userMessage, similarPairs, strategyText);

                // Build conversation messages for WebLLM
                const messages = [
                    { role: 'system', content: systemPrompt },
                    ...conversationHistory.slice(-4), // Last 2 exchanges
                    { role: 'user', content: userMessage }
                ];

                // Generate response with TinyLlama
                // Use creativity level from advanced controls

                // CRITICAL FIX: Minimum temperature for RAG contexts
                // At very low temperature, TinyLlama ignores RAG context and follows base training
                let effectiveTemperature = creativityLevel;
                if (similarPairs.length > 0 && creativityLevel < minRAGTemperature) {
                    effectiveTemperature = minRAGTemperature;
                    const statusText = minRAGTemperature <= 0.2 ? 'disabled (allowing low temp)' :
                                      minRAGTemperature >= 0.6 ? 'strict enforcement' : 'balanced protection';
                    console.log(`‚ö†Ô∏è Creativity too low (${creativityLevel.toFixed(1)}) - boosting to ${minRAGTemperature.toFixed(1)} for RAG context adherence (${statusText})`);
                }

                // Use experimental parameters with optional auto-adjustment
                let finalTopP = expTopP;
                let finalRepPenalty = expRepetitionPenalty;

                if (autoAdjustParams) {
                    // Auto-adjust top_p and repetition_penalty based on temperature
                    finalTopP = Math.min(0.99, 0.7 + (effectiveTemperature - 0.7) * 0.2);
                    finalRepPenalty = Math.max(1.0, 1.3 - (effectiveTemperature - 0.7) * 0.3);
                    console.log(`üîÑ Auto-adjusted: top_p=${finalTopP.toFixed(2)}, rep_penalty=${finalRepPenalty.toFixed(2)}`);
                }

                console.log(`üé® Generation params: temp=${effectiveTemperature.toFixed(1)}, top_p=${finalTopP.toFixed(2)}, top_k=${expTopK}, freq=${expFrequencyPenalty.toFixed(1)}, pres=${expPresencePenalty.toFixed(1)}, rep=${finalRepPenalty.toFixed(2)}, max=${expMaxTokens}${expSeed ? `, seed=${expSeed}` : ''}`);

                // Build completion params object
                const completionParams = {
                    messages: messages,
                    max_tokens: expMaxTokens,
                    temperature: effectiveTemperature,
                    top_p: finalTopP,
                    repetition_penalty: finalRepPenalty,
                    frequency_penalty: expFrequencyPenalty,
                };

                // Add optional parameters
                if (expPresencePenalty > 0) {
                    completionParams.presence_penalty = expPresencePenalty;
                }
                if (expTopK > 0) {
                    completionParams.top_k = expTopK;
                }
                if (expSeed !== null) {
                    completionParams.seed = expSeed;
                }

                const reply = await engine.chat.completions.create(completionParams);

                // Update live preview footer to show actual used values (including auto-adjusted)
                if (autoAdjustParams) {
                    // Temporarily show actual used values in footer
                    footerTopP.textContent = finalTopP.toFixed(2);
                    footerRep.textContent = finalRepPenalty.toFixed(2);
                    // Highlight them to show they were auto-adjusted
                    footerTopP.closest('.param-item').classList.add('changed');
                    footerRep.closest('.param-item').classList.add('changed');
                    setTimeout(() => {
                        footerTopP.closest('.param-item').classList.remove('changed');
                        footerRep.closest('.param-item').classList.remove('changed');
                    }, 1000);
                } else {
                    updateLivePreview();
                }

                // Extract response
                let finalResponse = reply.choices[0].message.content.trim();

                // Fallback if response is empty or nonsensical
                if (!finalResponse || finalResponse.length < 2) {
                    finalResponse = getCatResponse(userMessage);
                }

                // Add to conversation history (store clean content without thinking blocks for history)
                const { cleanContent } = parseThinkingBlocks(finalResponse);
                conversationHistory.push({ role: 'user', content: userMessage });
                conversationHistory.push({ role: 'assistant', content: cleanContent });

                // Keep history manageable (last 4 messages = 2 exchanges)
                if (conversationHistory.length > 4) {
                    conversationHistory = conversationHistory.slice(-4);
                }

                // Display response with thinking blocks and rating buttons
                addMessage(finalResponse, 'assistant', userMessage);

            } catch (error) {
                console.error('Error generating response:', error);
                // Fallback to cat response
                const catResponse = getCatResponse(userMessage);
                addMessage(catResponse, 'assistant', userMessage);
            } finally {
                isGenerating = false;
                sendBtn.disabled = false;
                chatInput.disabled = false;
                chatInput.focus();
            }
        }

        // Fun cat-themed responses as fallback
        function getCatResponse(message) {
            const lowerMsg = message.toLowerCase();

            // Model/identity questions
            if (lowerMsg.includes('model') || lowerMsg.includes('llm') || lowerMsg.includes('what are you')) {
                return "I'm a cat-powered AI running TinyLlama 1.1B in your browser! I'm tiny but mighty! Meow! üê±";
            }

            // Cat-related
            if (lowerMsg.includes('cat') || lowerMsg.includes('meow')) {
                const catResponses = [
                    "Meow! üò∫",
                    "I'm a cat person myself. Obviously. üê±",
                    "Cats are the superior species, obviously!",
                    "Purr purr... what were you saying?",
                ];
                return catResponses[Math.floor(Math.random() * catResponses.length)];
            }

            // Moon-related
            if (lowerMsg.includes('moon')) {
                return "The moon belongs to cats! Haven't you heard? üåôüê±";
            }

            // Greetings
            if (lowerMsg.match(/^(hi|hello|hey|sup|yo)/)) {
                const greetings = [
                    "Hello, human! Ready to discuss important cat matters?",
                    "Meow! What brings you to the moon today?",
                    "Hey there! I'm just a cat on the moon, living my best life. üåô",
                ];
                return greetings[Math.floor(Math.random() * greetings.length)];
            }

            // Default responses
            const defaults = [
                "That's an interesting question! As a cat, I have strong opinions about it. üò∫",
                "Hmm, let me think about that while I take a cat nap... üí§",
                "I'm just a simple moon cat. My expertise is mostly in napping and moon ownership. üåô",
                "Fascinating! Tell me more while I knock things off this lunar surface. üêæ",
            ];
            return defaults[Math.floor(Math.random() * defaults.length)];
        }

        // Send message handler
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isGenerating) return;

            // Add user message to chat
            addMessage(message, 'user');
            chatInput.value = '';

            // Generate response
            await generateResponse(message);
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Toggle dialog visibility
        chatBubble.addEventListener('click', async function() {
            const isActive = supportDialog.classList.contains('active');
            if (!isActive) {
                supportDialog.classList.add('active');
                loadRandomCat();

                // Initialize learning database on first open
                if (!learningDB) {
                    await initLearningDB();
                    const stats = await getLearningStats();
                    if (stats.total > 0) {
                        console.log(`üìö Loaded ${stats.liked} learned responses!`);
                    }

                    // Backfill embeddings for existing data (if embeddings are ready)
                    backfillEmbeddings();
                }

                // Model initialization now happens via "Load Model" button
                // to allow user to select model before loading
            } else {
                supportDialog.classList.remove('active');
            }
        });

        // Close dialog
        closeBtn.addEventListener('click', function() {
            supportDialog.classList.remove('active');
        });

        // Close dialog when clicking outside of it
        document.addEventListener('click', function(event) {
            if (!supportDialog.contains(event.target) && !chatBubble.contains(event.target)) {
                supportDialog.classList.remove('active');
            }
        });

        // ============================================
        // ULTRA-CLEVER LEARNING FEATURES
        // ============================================

        // DOM elements for training rocket
        const trainingRocket = document.getElementById('trainingRocket');
        const trainingPanel = document.getElementById('trainingPanel');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const knowledgeBadge = document.getElementById('knowledgeBadge');
        const fuelFill = document.getElementById('fuelFill');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        // ============================================
        // PHASE 2: DOM ACTION EXECUTOR
        // ============================================

        // Safe DOM action whitelist - Only these actions are allowed
        const ALLOWED_DOM_ACTIONS = {
            'show-panel': (action) => {
                const validPanels = ['trainingPanel', 'ragInspectorPanel', 'llmParamsPanel', 'analyticsPanel', 'databaseModal'];
                const panelId = action.panel;
                if (validPanels.includes(panelId)) {
                    const panel = document.getElementById(panelId);
                    if (panel) {
                        panel.style.display = action.display || 'flex';
                        panel.classList.add('active');
                        console.log(`‚úÖ DOM Action: Showed panel "${panelId}"`);
                        return true;
                    }
                }
                return false;
            },

            'hide-panel': (action) => {
                const panelId = action.panel;
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.style.display = 'none';
                    panel.classList.remove('active');
                    console.log(`‚úÖ DOM Action: Hid panel "${panelId}"`);
                    return true;
                }
                return false;
            },

            'highlight-element': (action) => {
                const el = document.querySelector(action.selector);
                if (el) {
                    const originalBg = el.style.background;
                    el.style.background = action.color || 'rgba(139, 92, 246, 0.2)';
                    el.style.transition = 'background 0.3s';

                    setTimeout(() => {
                        el.style.background = originalBg;
                    }, action.duration || 2000);

                    console.log(`‚úÖ DOM Action: Highlighted "${action.selector}"`);
                    return true;
                }
                return false;
            },

            'add-stars': (action) => {
                const count = Math.min(Math.max(action.count || 10, 0), 50); // Limit 0-50
                const starsContainer = document.querySelector('.stars');
                if (starsContainer) {
                    for (let i = 0; i < count; i++) {
                        const star = document.createElement('div');
                        star.className = 'star';
                        star.style.left = Math.random() * 100 + '%';
                        star.style.top = Math.random() * 100 + '%';
                        star.style.animationDelay = Math.random() * 3 + 's';
                        starsContainer.appendChild(star);
                    }
                    console.log(`‚úÖ DOM Action: Added ${count} stars`);
                    return true;
                }
                return false;
            },

            'scroll-to': (action) => {
                const el = document.querySelector(action.selector);
                if (el) {
                    el.scrollIntoView({
                        behavior: action.smooth ? 'smooth' : 'auto',
                        block: action.block || 'start'
                    });
                    console.log(`‚úÖ DOM Action: Scrolled to "${action.selector}"`);
                    return true;
                }
                return false;
            },

            'set-creativity': (action) => {
                const value = Math.min(Math.max(action.value || 0.7, 0.1), 1.5);
                creativityLevel = value;
                const slider = document.getElementById('creativitySlider');
                if (slider) {
                    slider.value = value;
                    document.getElementById('creativityValue').textContent = value.toFixed(2);
                }
                console.log(`‚úÖ DOM Action: Set creativity to ${value}`);
                return true;
            },

            'notify': (action) => {
                const message = action.message || 'Notification';
                showLearningNotification(message);
                console.log(`‚úÖ DOM Action: Showed notification "${message}"`);
                return true;
            }
        };

        // Execute DOM action with safety checks
        function executeDOMAction(action) {
            if (!action || !action.type) {
                console.warn('‚ö†Ô∏è Invalid DOM action:', action);
                return false;
            }

            // Security check: Only execute if permission is 'allowed'
            if (action.permission !== 'allowed') {
                console.warn(`‚ö†Ô∏è DOM action "${action.type}" not permitted (permission: ${action.permission})`);
                return false;
            }

            // Execute after optional delay
            const executeNow = () => {
                const executor = ALLOWED_DOM_ACTIONS[action.type];
                if (executor) {
                    try {
                        const success = executor(action);
                        if (success) {
                            console.log(`‚úÖ Executed DOM action: ${action.type}`);
                        } else {
                            console.warn(`‚ö†Ô∏è DOM action failed: ${action.type}`);
                        }
                        return success;
                    } catch (error) {
                        console.error(`‚ùå Error executing DOM action "${action.type}":`, error);
                        return false;
                    }
                } else {
                    console.warn(`‚ö†Ô∏è Unknown DOM action type: ${action.type}`);
                    return false;
                }
            };

            if (action.delay && action.delay > 0) {
                setTimeout(executeNow, action.delay);
                return true; // Assume success for delayed actions
            } else {
                return executeNow();
            }
        }

        // Execute multiple DOM actions from a RAG result
        function executeRAGDOMActions(ragResult, trigger = 'on-answer-shown') {
            if (!ragResult || !ragResult.domActions || ragResult.domActions.length === 0) {
                return 0;
            }

            let executed = 0;
            ragResult.domActions.forEach(action => {
                // Only execute actions matching the trigger
                if (action.trigger === trigger || !action.trigger) {
                    if (executeDOMAction(action)) {
                        executed++;
                    }
                }
            });

            if (executed > 0) {
                console.log(`‚úÖ Executed ${executed} DOM action(s) for trigger "${trigger}"`);
            }

            return executed;
        }

        // Category detection - Ultra-clever feature!
        function detectCategory(question) {
            const q = question.toLowerCase();

            if (q.match(/who|what.*you|your name|introduce/)) return 'identity';
            if (q.match(/cat|kitten|feline|meow|purr/)) return 'cats';
            if (q.match(/moon|lunar|space|astronaut|rocket/)) return 'moon';
            if (q.match(/how.*work|explain|what.*do|capability/)) return 'technical';
            if (q.match(/help|assist|can you|support/)) return 'support';
            if (q.match(/hi|hello|hey|greet/)) return 'greeting';
            if (q.match(/thank|thanks|appreciate/)) return 'gratitude';
            return 'general';
        }

        // Enhanced similarity with SEMANTIC VECTOR SEARCH + category weighting + MANGO QUERIES
        async function findSimilarQuestionsEnhanced(question, limit = 3) {
            console.log('üîç RAG SEARCH START (PouchDB + Mango)');
            console.log(`   Query: "${question}"`);

            if (!learningDB) await initLearningDB();

            const questionCategory = detectCategory(question);
            console.log(`   Category: ${questionCategory}`);

            // üöÄ MANGO QUERY: Pre-filter at database level (MASSIVE performance boost!)
            const candidateLimit = 100; // Only fetch top 100 candidates instead of ALL
            let pairs = [];

            try {
                const result = await learningDB.find({
                    selector: {
                        type: 'question-answer',
                        rating: { $in: ['star3', 'star2', 'star1', 'up'] }, // Exclude thumbs-down
                        $or: [
                            { category: questionCategory },
                            { category: 'general' }
                        ]
                    },
                    // Note: No sort here - we sort by similarity after cosine calculation anyway
                    limit: candidateLimit
                });
                pairs = result.docs;
                console.log(`   üéØ Mango pre-filtered: ${pairs.length} candidates (from database)`);
            } catch (error) {
                // Fallback: if Mango query fails, get all and filter manually
                console.warn('   ‚ö†Ô∏è Mango query failed, falling back to allDocs:', error);
                const allResult = await learningDB.allDocs({ include_docs: true });
                pairs = allResult.rows
                    .map(row => row.doc)
                    .filter(doc => doc.type === 'question-answer' && doc.rating && doc.rating !== 'down');
            }

            console.log(`   Database candidates: ${pairs.length}`);

            // Generate embedding for the question
            const questionEmbedding = await generateEmbedding(question);
            console.log(`   Embedding: ${questionEmbedding ? '‚úì Generated (384-dim)' : '‚úó Using keyword fallback'}`);

            const scored = await Promise.all(pairs.map(async pair => {
                let similarity = 0;
                let method = '';

                // Try semantic similarity first (if embeddings available)
                if (questionEmbedding && pair.embedding) {
                    // Cosine similarity between embeddings
                    similarity = cosineSimilarity(questionEmbedding, pair.embedding);
                    method = 'semantic';
                } else {
                    // Fallback to keyword matching
                    const questionWords = question.toLowerCase().split(/\s+/);
                    const pairWords = pair.question.split(/\s+/);
                    const commonWords = questionWords.filter(w => pairWords.includes(w)).length;
                    similarity = commonWords / Math.max(questionWords.length, pairWords.length);
                    method = 'keyword';
                }

                const originalSimilarity = similarity;

                // Category boost - ultra-clever!
                const pairCategory = pair.category || detectCategory(pair.question);
                let categoryBoost = false;
                if (pairCategory === questionCategory) {
                    similarity *= 1.3; // Boost same-category matches
                    categoryBoost = true;
                }

                // Star rating multiplier - quality weighting!
                let ratingMultiplier = 1.0;
                let ratingBoost = false;
                if (pair.rating === 'star3') {
                    ratingMultiplier = 1.2; // Excellent answers get boosted
                    ratingBoost = true;
                } else if (pair.rating === 'star2' || pair.rating === 'up') {
                    ratingMultiplier = 1.0; // Good answers (normal weight) - 'up' for backward compatibility
                } else if (pair.rating === 'star1') {
                    ratingMultiplier = 0.8; // Okay answers get de-prioritized
                    ratingBoost = true;
                }

                similarity *= ratingMultiplier;

                // üéØ PHASE 2: Context-aware boost - DOM state matching!
                let contextBoost = false;
                let contextMatch = 0;
                if (pair.contextRules) {
                    const currentDOM = getCurrentDOMState();

                    // Check if this answer prefers current DOM state
                    if (pair.contextRules.preferredTheme) {
                        if (pair.contextRules.preferredTheme === currentDOM.theme) {
                            similarity *= 1.15; // Boost answers designed for current theme
                            contextBoost = true;
                            contextMatch++;
                        }
                    }

                    // More context rules can be added here (moon_visible, time_of_day, etc.)
                }

                // Clip to max 1.0 (cosine similarity cannot exceed 1.0)
                similarity = Math.min(similarity, 1.0);

                return { ...pair, similarity, category: pairCategory, originalSimilarity, categoryBoost, method, ratingMultiplier, ratingBoost, contextBoost, contextMatch };
            }));

            // Log top candidates before filtering
            const topCandidates = scored
                .sort((a, b) => b.similarity - a.similarity)
                .slice(0, 10);

            console.log(`\n   üìä Top 10 candidates (before filtering):`);
            topCandidates.forEach((p, i) => {
                const answerPreview = p.answer.substring(0, 60) + (p.answer.length > 60 ? '...' : '');
                const boostLabels = [];
                if (p.categoryBoost) boostLabels.push(`+30% ${p.category}`);
                if (p.ratingBoost) {
                    if (p.ratingMultiplier > 1.0) boostLabels.push(`+20% ‚≠ê‚≠ê‚≠ê`);
                    else if (p.ratingMultiplier < 1.0) boostLabels.push(`-20% ‚≠ê`);
                }
                if (p.contextBoost) boostLabels.push(`+15% üéØ context`);
                const boostLabel = boostLabels.length > 0 ? ` [${boostLabels.join(', ')}]` : '';
                const methodLabel = p.method === 'semantic' ? 'üß†' : 'üî§';
                const ratingLabel = p.rating === 'star3' ? '‚≠ê‚≠ê‚≠ê' : p.rating === 'star2' ? '‚≠ê‚≠ê' : p.rating === 'star1' ? '‚≠ê' : p.rating === 'down' ? 'üëé' : p.rating === 'up' ? 'üëç' : '‚ö™';
                console.log(`   ${i+1}. ${methodLabel} Score: ${p.similarity.toFixed(3)}${boostLabel} | ${ratingLabel}`);
                console.log(`      Q: "${p.question}"`);
                console.log(`      A: "${answerPreview}"`);
            });

            const filtered = scored
                .filter(p => {
                    // Exclude thumbs-down and unrated entries
                    if (p.rating === 'down' || !p.rating) return false;
                    // Accept any star rating (star1, star2, star3) or legacy 'up'
                    return p.similarity > 0.25;
                })
                .sort((a, b) => b.similarity - a.similarity)
                .slice(0, limit);

            console.log(`\n   ‚úÖ Final matches (threshold: >0.25, stars only, limit: ${limit}):`);
            if (filtered.length > 0) {
                filtered.forEach((p, i) => {
                    const answerPreview = p.answer.substring(0, 80) + (p.answer.length > 80 ? '...' : '');
                    const boostParts = [];
                    if (p.categoryBoost) boostParts.push(`cat: ${p.originalSimilarity.toFixed(3)}`);
                    if (p.ratingBoost) boostParts.push(`rating: √ó${p.ratingMultiplier}`);
                    const boostLabel = boostParts.length > 0 ? ` (${boostParts.join(', ')})` : '';
                    console.log(`   ${i+1}. Score: ${p.similarity.toFixed(3)}${boostLabel}`);
                    console.log(`      Q: "${p.question}"`);
                    console.log(`      A: "${answerPreview}"`);
                });
            } else {
                console.log('   ‚ö†Ô∏è No matches found (all below threshold or no thumbs-up ratings)');
            }

            // Store RAG results for RLHF tracking
            lastRAGResults = filtered.map(p => ({
                question: p.question,
                answer: p.answer,
                similarity: p.similarity
            }));

            console.log('üîç RAG SEARCH END\n');
            return filtered;
        }

        // Update learning analytics display
        async function updateAnalytics() {
            const stats = await getLearningStats();
            const result = await learningDB.allDocs({ include_docs: true });
            const allPairs = result.rows
                .map(row => row.doc)
                .filter(doc => doc.type === 'question-answer');

            // Update badge and fuel
            knowledgeBadge.textContent = stats.liked;
            const progress = Math.min((stats.liked / 50) * 100, 100); // 50 is "full tank"
            fuelFill.style.width = progress + '%';

            // Update stats
            document.getElementById('statTotal').textContent = stats.total;
            document.getElementById('statLiked').textContent = stats.liked;
            document.getElementById('statProgress').textContent = Math.round(progress) + '%';

            // Update star rating breakdown
            document.getElementById('statStar3').textContent = stats.star3;
            document.getElementById('statStar2').textContent = stats.star2;
            document.getElementById('statStar1').textContent = stats.star1;
            document.getElementById('statDown').textContent = stats.disliked;

            // Category breakdown (include all star ratings)
            const categories = {};
            allPairs.filter(p => p.rating === 'up' || p.rating === 'star1' || p.rating === 'star2' || p.rating === 'star3').forEach(pair => {
                const cat = detectCategory(pair.question);
                categories[cat] = (categories[cat] || 0) + 1;
            });

            const categoryBreakdown = document.getElementById('categoryBreakdown');
            const catHTML = '<h4 style="font-size: 14px; margin-bottom: 10px; color: #333;">Knowledge Categories</h4>';
            const catItems = Object.entries(categories).map(([cat, count]) => {
                const percent = (count / stats.liked) * 100;
                return `
                    <div class="category-item">
                        <div class="category-name">${cat.charAt(0).toUpperCase() + cat.slice(1)} (${count})</div>
                        <div class="category-bar">
                            <div class="category-bar-fill" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            categoryBreakdown.innerHTML = catHTML + catItems;

            // Update training export stats
            const alpacaData = toAlpacaFormat(allPairs);
            const dpoData = toDPOFormat(allPairs);
            const qualityPercent = stats.total > 0 ? Math.round((alpacaData.length / stats.total) * 100) : 0;

            document.getElementById('trainingExamples').textContent = alpacaData.length;
            document.getElementById('preferencePairs').textContent = dpoData.length;
            document.getElementById('qualityScore').textContent = qualityPercent + '%';
        }

        // ============================================
        // TRAINING EXPORT SYSTEM (RLHF/DPO)
        // ============================================

        // Quality filtering for training data
        function filterQualityExamples(qaPairs) {
            return qaPairs.filter(pair => {
                // Minimum requirements - accept all star ratings (star1, star2, star3) and legacy 'up'
                if (pair.rating !== 'up' && pair.rating !== 'star1' && pair.rating !== 'star2' && pair.rating !== 'star3') return false;
                if (!pair.answer || pair.answer.length < 10) return false;
                if (!pair.question || pair.question.length < 3) return false;

                return true;
            });
        }

        // Convert to Alpaca format (Supervised Fine-Tuning)
        function toAlpacaFormat(qaPairs) {
            const qualityPairs = filterQualityExamples(qaPairs);

            return qualityPairs.map(p => ({
                instruction: p.system_prompt || currentSystemPrompt,
                input: p.question,
                output: p.answer,
                metadata: {
                    rating: p.rating,
                    timestamp: p.timestamp,
                    category: p.category || detectCategory(p.question),
                    rag_used: (p.rag_context && p.rag_context.length > 0),
                    conversation_turns: (p.conversation_context && p.conversation_context.length) || 0,
                    source: "user_feedback"
                }
            }));
        }

        // Convert to DPO format (Direct Preference Optimization)
        function toDPOFormat(qaPairs) {
            const pairs = [];

            // Group by question to find preference pairs
            const grouped = {};
            qaPairs.forEach(pair => {
                const q = pair.question;
                if (!grouped[q]) grouped[q] = [];
                grouped[q].push(pair);
            });

            // Create preference pairs
            for (const [question, answers] of Object.entries(grouped)) {
                const chosen = answers.find(a => a.rating === 'up');
                const rejected = answers.find(a => a.rating === 'down');

                if (chosen && rejected) {
                    pairs.push({
                        prompt: `${chosen.system_prompt || currentSystemPrompt}\n\nUser: ${question}`,
                        chosen: chosen.answer,
                        rejected: rejected.answer,
                        metadata: {
                            chosen_timestamp: chosen.timestamp,
                            rejected_timestamp: rejected.timestamp,
                            category: chosen.category || detectCategory(question),
                            preference_strength: 1.0
                        }
                    });
                }
            }

            return pairs;
        }

        // Generate training configuration
        function generateTrainingConfig(stats) {
            return {
                base_model: "TinyLlama/TinyLlama-1.1B-Chat-v0.4",
                task_type: "causal_lm",

                // LoRA Configuration
                peft_type: "LORA",
                lora_r: 16,
                lora_alpha: 32,
                lora_dropout: 0.05,
                lora_target_modules: ["q_proj", "v_proj", "k_proj", "o_proj"],

                // Training Hyperparameters
                learning_rate: 0.0002,
                lr_scheduler_type: "cosine",
                warmup_ratio: 0.03,
                num_train_epochs: 3,
                per_device_train_batch_size: 4,
                gradient_accumulation_steps: 4,
                max_seq_length: 512,

                // DPO-specific
                dpo_beta: 0.1,

                // Dataset Info
                dataset_stats: {
                    total_examples: stats.total,
                    positive_examples: stats.liked,
                    preference_pairs: stats.preference_pairs || 0,
                    date_collected: new Date().toISOString()
                },

                // Output
                output_dir: "./finetuned_model",
                save_strategy: "epoch",
                logging_steps: 10
            };
        }

        // Generate training script
        function generateTrainingScript() {
            return `#!/usr/bin/env python3
"""
Auto-generated training script by Cats Own The Moon
Train TinyLlama with your custom feedback data
"""

import argparse
import json
import yaml
from pathlib import Path

def train_with_unsloth(config_path, data_file):
    """Train with Unsloth (fastest, needs CUDA)"""
    print("üöÄ Training with Unsloth...")

    try:
        from unsloth import FastLanguageModel
        from trl import SFTTrainer
        from transformers import TrainingArguments
        import torch
    except ImportError:
        print("‚ùå Please install: pip install unsloth trl transformers")
        return

    # Load config
    with open(config_path) as f:
        config = yaml.safe_load(f)

    # Load model
    model, tokenizer = FastLanguageModel.from_pretrained(
        model_name=config['base_model'],
        max_seq_length=config['max_seq_length'],
        load_in_4bit=True
    )

    # Add LoRA adapters
    model = FastLanguageModel.get_peft_model(
        model,
        r=config['lora_r'],
        lora_alpha=config['lora_alpha'],
        lora_dropout=config['lora_dropout'],
        target_modules=config['lora_target_modules']
    )

    # Load dataset
    with open(data_file) as f:
        data = [json.loads(line) for line in f if line.strip()]

    # Format for training
    def format_prompt(example):
        return f"""<|system|>
{example['instruction']}
<|user|>
{example['input']}
<|assistant|>
{example['output']}"""

    # Train
    trainer = SFTTrainer(
        model=model,
        tokenizer=tokenizer,
        train_dataset=data,
        dataset_text_field="text",
        max_seq_length=config['max_seq_length'],
        formatting_func=format_prompt,
        args=TrainingArguments(
            output_dir=config['output_dir'],
            per_device_train_batch_size=config['per_device_train_batch_size'],
            gradient_accumulation_steps=config['gradient_accumulation_steps'],
            warmup_ratio=config['warmup_ratio'],
            num_train_epochs=config['num_train_epochs'],
            learning_rate=config['learning_rate'],
            logging_steps=config['logging_steps'],
            save_strategy=config['save_strategy'],
            fp16=torch.cuda.is_available()
        )
    )

    trainer.train()

    # Save
    model.save_pretrained(config['output_dir'])
    tokenizer.save_pretrained(config['output_dir'])

    print(f"‚úÖ Training complete! Model saved to {config['output_dir']}")


def train_with_mlx(config_path, data_file):
    """Train with MLX (Apple Silicon)"""
    print("üçé Training with MLX (Apple Silicon)...")
    print("‚ö†Ô∏è  MLX training code not yet implemented")
    print("See: https://github.com/ml-explore/mlx-examples")


def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("--method", choices=["unsloth", "mlx"], default="unsloth")
    parser.add_argument("--config", default="training_config.yaml")
    parser.add_argument("--data", default="alpaca_format.jsonl")
    args = parser.parse_args()

    if args.method == "unsloth":
        train_with_unsloth(args.config, args.data)
    elif args.method == "mlx":
        train_with_mlx(args.config, args.data)


if __name__ == "__main__":
    main()
`;
        }

        // Generate README
        function generateREADME(stats) {
            return `# TinyLlama Training Package

Generated by **Cats Own The Moon** on ${new Date().toISOString()}

## üìä Dataset Statistics

- **Total Examples**: ${stats.total}
- **Quality Examples (üëç)**: ${stats.liked}
- **Preference Pairs (DPO)**: ${stats.preference_pairs || 0}
- **Categories**: ${Object.keys(stats.by_category || {}).join(', ')}

## üöÄ Quick Start

### Option 1: Unsloth (Fastest - NVIDIA GPU)

\`\`\`bash
# Install dependencies
pip install unsloth trl transformers pyyaml

# Train
python train.py --method unsloth
\`\`\`

**Requirements**: NVIDIA GPU with 8GB+ VRAM (RTX 3060 or better)

### Option 2: Google Colab (Free GPU)

1. Upload this entire folder to Google Drive
2. Open Google Colab
3. Mount Drive and navigate to folder
4. Run: \`!python train.py --method unsloth\`

### Option 3: MLX (Apple Silicon)

\`\`\`bash
# Coming soon - MLX training support
python train.py --method mlx
\`\`\`

## üìÅ Files Included

- \`alpaca_format.jsonl\` - Supervised fine-tuning data
- \`dpo_format.jsonl\` - Preference pairs for DPO training
- \`training_config.yaml\` - Hyperparameters and settings
- \`train.py\` - Auto-generated training script
- \`rag_corpus.json\` - Full dataset with metadata
- \`README.md\` - This file

## üéØ After Training

### Deploy to Browser

1. Convert to WebLLM format:
\`\`\`bash
# Coming soon - conversion script
\`\`\`

2. Host locally or upload to HuggingFace
3. Update model_id in your HTML

## üìö Learn More

- [Unsloth Documentation](https://github.com/unslothai/unsloth)
- [TRL Documentation](https://huggingface.co/docs/trl)
- [DPO Paper](https://arxiv.org/abs/2305.18290)

---

Made with üê± and üåô
`;
        }

        // Export training package as ZIP
        exportBtn.addEventListener('click', async function() {
            try {
                showLearningNotification('üì¶ Generating training package...');

                const result = await learningDB.allDocs({ include_docs: true });
                const allPairs = result.rows
                    .map(row => row.doc)
                    .filter(doc => doc.type === 'question-answer');

                // Generate formats
                const alpacaData = toAlpacaFormat(allPairs);
                const dpoData = toDPOFormat(allPairs);

                // Calculate stats
                const stats = await getLearningStats();
                stats.preference_pairs = dpoData.length;
                stats.by_category = {};
                allPairs.filter(p => p.rating === 'up').forEach(p => {
                    const cat = p.category || detectCategory(p.question);
                    stats.by_category[cat] = (stats.by_category[cat] || 0) + 1;
                });

                const config = generateTrainingConfig(stats);

                // Create ZIP
                const zip = new JSZip();

                // Add data files
                zip.file("alpaca_format.jsonl",
                    alpacaData.map(item => JSON.stringify(item)).join('\n'));

                zip.file("dpo_format.jsonl",
                    dpoData.map(item => JSON.stringify(item)).join('\n'));

                zip.file("training_config.yaml",
                    jsyaml.dump(config));

                zip.file("rag_corpus.json",
                    JSON.stringify({
                        version: 2,
                        exported: new Date().toISOString(),
                        stats: stats,
                        pairs: allPairs.map(p => ({
                            question: p.question,
                            answer: p.answer,
                            rating: p.rating,
                            category: p.category || detectCategory(p.question),
                            timestamp: p.timestamp,
                            conversation_context: p.conversation_context,
                            system_prompt: p.system_prompt,
                            rag_context: p.rag_context,
                            model_version: p.model_version,
                            inference_params: p.inference_params
                        }))
                    }, null, 2));

                // Add training script
                zip.file("train.py", generateTrainingScript());

                // Add README
                zip.file("README.md", generateREADME(stats));

                // Generate and download ZIP
                const blob = await zip.generateAsync({type: "blob"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tinyllama-training-${Date.now()}.zip`;
                a.click();
                URL.revokeObjectURL(url);

                showLearningNotification(`‚úÖ Exported ${alpacaData.length} examples, ${dpoData.length} preference pairs!`);
            } catch (error) {
                console.error('Export error:', error);
                showLearningNotification('‚ùå Export failed! Check console.');
            }
        });

        // Clear database
        clearBtn.addEventListener('click', async function() {
            if (confirm('Are you sure you want to clear all learning data? This cannot be undone!')) {
                try {
                    // Get all docs and delete them
                    const result = await learningDB.allDocs();
                    const docsToDelete = result.rows.map(row => ({
                        _id: row.id,
                        _rev: row.value.rev,
                        _deleted: true
                    }));
                    await learningDB.bulkDocs(docsToDelete);

                    await updateAnalytics();
                    showLearningNotification('üóëÔ∏è All learning data cleared!');
                } catch (error) {
                    console.error('Error clearing database:', error);
                    showLearningNotification('‚ùå Failed to clear database');
                }
            }
        });

        // ============================================
        // TEXT UPLOAD & KNOWLEDGE BASE EXPANSION
        // ============================================

        // DOM elements for text upload
        const textUpload = document.getElementById('textUpload');
        const processTextBtn = document.getElementById('processTextBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        const uploadProgress = document.getElementById('uploadProgress');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadProgressText = document.getElementById('uploadProgressText');

        // Debug tools elements
        const clearLearningsBtn = document.getElementById('clearLearningsBtn');
        const viewDatabaseBtn = document.getElementById('viewDatabaseBtn');
        const toggleRAGInspectorBtn = document.getElementById('toggleRAGInspectorBtn');
        const toggleConsoleLogBtn = document.getElementById('toggleConsoleLogBtn');

        // Intelligent text chunking with sentence boundaries
        function intelligentChunk(text, maxWords = 400, overlapWords = 80) {
            // COMPREHENSIVE emoji removal - ALL Unicode emoji blocks
            text = text
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '') // Emoticons
                .replace(/[\u{1F300}-\u{1F5FF}]/gu, '') // Misc Symbols and Pictographs
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '') // Transport and Map Symbols
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '') // Flags (iOS)
                .replace(/[\u{2600}-\u{26FF}]/gu, '')   // Misc symbols
                .replace(/[\u{2700}-\u{27BF}]/gu, '')   // Dingbats
                .replace(/[\u{1F900}-\u{1F9FF}]/gu, '') // Supplemental Symbols and Pictographs
                .replace(/[\u{1FA00}-\u{1FA6F}]/gu, '') // Chess Symbols
                .replace(/[\u{1FA70}-\u{1FAFF}]/gu, '') // Symbols and Pictographs Extended-A
                .replace(/[\u{2300}-\u{23FF}]/gu, '')   // Miscellaneous Technical
                .replace(/[\u{FE00}-\u{FE0F}]/gu, '')   // Variation Selectors
                .replace(/[\u{1F000}-\u{1F02F}]/gu, '') // Mahjong Tiles
                .replace(/[\u{1F0A0}-\u{1F0FF}]/gu, '') // Playing Cards
                .trim()
                .replace(/\s+/g, ' ');

            // Clean markdown formatting
            text = text
                .replace(/^#+\s+/gm, '')        // Remove heading markers
                .replace(/\*\*([^*]+)\*\*/g, '$1') // Bold
                .replace(/\*([^*]+)\*/g, '$1')     // Italic
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Links
                .replace(/^[-*]\s+/gm, '')      // List markers
                .replace(/^>\s+/gm, '')         // Blockquotes
                .trim();

            // Split by paragraph first, then by sentences
            const paragraphs = text.split(/\n\n+/);
            const sentences = [];

            for (const para of paragraphs) {
                // Better sentence splitting that respects abbreviations
                const paraSentences = para.match(/[^.!?]+[.!?]+(?:\s|$)/g) || [para];
                sentences.push(...paraSentences.map(s => s.trim()).filter(s => s.length > 0));
            }

            const chunks = [];
            let currentChunk = [];
            let currentWordCount = 0;

            for (const sentence of sentences) {
                const sentenceWords = sentence.split(/\s+/).length;

                if (currentWordCount + sentenceWords > maxWords && currentChunk.length > 0) {
                    // Save current chunk
                    chunks.push(currentChunk.join(' ').trim());

                    // Start new chunk with overlap (last 2-3 sentences)
                    const overlapSentences = Math.min(3, Math.floor(currentChunk.length * 0.3));
                    currentChunk = currentChunk.slice(-overlapSentences);
                    currentWordCount = currentChunk.join(' ').split(/\s+/).length;
                }

                currentChunk.push(sentence);
                currentWordCount += sentenceWords;
            }

            // Add final chunk
            if (currentChunk.length > 0) {
                chunks.push(currentChunk.join(' ').trim());
            }

            return chunks;
        }

        // Extract keywords from text
        function extractKeywords(text, limit = 5) {
            // Remove common stop words
            const stopWords = new Set(['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by', 'from', 'as', 'is', 'was', 'are', 'were', 'been', 'be', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'should', 'could', 'may', 'might', 'can', 'this', 'that', 'these', 'those', 'i', 'you', 'he', 'she', 'it', 'we', 'they', 'what', 'which', 'who', 'when', 'where', 'why', 'how']);

            const words = text.toLowerCase()
                .replace(/[^\w\s]/g, ' ')
                .split(/\s+/)
                .filter(w => w.length > 3 && !stopWords.has(w));

            // Count frequency
            const freq = {};
            words.forEach(w => freq[w] = (freq[w] || 0) + 1);

            // Sort by frequency
            return Object.entries(freq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit)
                .map(([word]) => word);
        }

        // Generate Q&A pairs from a chunk - ROBUST VERSION
        function generateQAPairsFromChunk(chunk, chunkIndex) {
            const pairs = [];
            const sentences = chunk.match(/[^.!?]+[.!?]+(?:\s|$)/g) || [chunk];

            // Clean sentences (remove extra whitespace, parentheses content markers)
            const cleanSentences = sentences.map(s => s.trim()).filter(s => s.length > 10);

            // STRATEGY 0: Detect acronyms and abbreviations (PRIORITY!)
            // Look for patterns like "(WIA)", "**WIA**", or "ACRONYM:"
            const acronymPattern = /\(([A-Z]{2,})\)|\*\*([A-Z]{2,})\*\*|([A-Z]{2,}):/g;
            let acronymMatch;
            while ((acronymMatch = acronymPattern.exec(chunk)) !== null) {
                const acronym = acronymMatch[1] || acronymMatch[2] || acronymMatch[3];

                // Find the sentence containing this acronym for context
                for (const sentence of cleanSentences) {
                    if (sentence.includes(acronym)) {
                        // Extract explanation from the sentence
                        const explanation = sentence.trim();
                        pairs.push({
                            question: `What is ${acronym}?`,
                            answer: explanation
                        });
                        break; // Only use first occurrence
                    }
                }
            }

            // STRATEGY 1: Definitions - "X is Y" or "X are Y" patterns
            for (const sentence of cleanSentences) {
                // Only match if we have a clear subject (at least 2 words before is/are)
                const defMatch = sentence.match(/^([A-Z][^.!?]{10,}?)\s+(is|are)\s+([^.!?]{10,})/);
                if (defMatch) {
                    const subject = defMatch[1].trim();
                    const predicate = defMatch[3].trim();

                    // Validate: subject must be complete words (no trailing partial words)
                    if (subject.match(/\w+\s+\w+/) && !subject.endsWith(' w') && !subject.endsWith(' h')) {
                        pairs.push({
                            question: `What ${defMatch[2]} ${subject}?`,
                            answer: sentence.trim()
                        });
                    }
                }
            }

            // STRATEGY 2: Explanations - "because", "since", "due to"
            for (const sentence of cleanSentences) {
                const causeMatch = sentence.match(/^([^,]{15,}?),?\s+(because|since|due to|as)\s+(.{15,})/i);
                if (causeMatch) {
                    const effect = causeMatch[1].trim();
                    const cause = causeMatch[3].trim();

                    // Validate completeness
                    if (effect.match(/\w+\s+\w+/) && !effect.endsWith(' w') && !effect.endsWith(' h')) {
                        pairs.push({
                            question: `Why ${effect.toLowerCase()}?`,
                            answer: sentence.trim()
                        });
                    }
                }
            }

            // STRATEGY 3: Named entities - detect proper nouns and titles
            const titlePattern = /(?:^|\. )([A-Z][a-z]+(?:\s+[A-Z][a-z]+){1,4})\s+(is|are|was|were)\s+([^.!?]{10,})/g;
            let titleMatch;
            while ((titleMatch = titlePattern.exec(chunk)) !== null) {
                const entity = titleMatch[1].trim();
                const description = titleMatch[3].trim();

                if (entity.length > 5 && description.length > 15) {
                    pairs.push({
                        question: `Who or what is ${entity}?`,
                        answer: `${entity} ${titleMatch[2]} ${description}.`
                    });
                }
            }

            // STRATEGY 4: General topic questions from keywords
            if (pairs.length === 0) {
                const keywords = extractKeywords(chunk, 3);
                if (keywords.length >= 2) {
                    const topicQuestion = `Tell me about ${keywords.slice(0, 2).join(' and ')}.`;
                    pairs.push({
                        question: topicQuestion,
                        answer: chunk.substring(0, 300).trim() + (chunk.length > 300 ? '...' : '')
                    });
                }
            }

            // STRATEGY 5: Fallback - create a general contextual question
            if (pairs.length === 0 && cleanSentences.length > 0) {
                const firstSentence = cleanSentences[0];
                const keywords = extractKeywords(firstSentence, 2);

                if (keywords.length > 0) {
                    pairs.push({
                        question: `What about ${keywords[0]}?`,
                        answer: chunk.substring(0, 400).trim() + (chunk.length > 400 ? '...' : '')
                    });
                }
            }

            // VALIDATION: Remove malformed questions
            const validPairs = pairs.filter(p => {
                // Must have complete words (no fragments like "w?" or "he w?")
                const hasCompleteWords = !p.question.match(/\s[a-z]\?$/) && !p.question.match(/\s\w\s\w\?/);
                // Must be at least 10 chars
                const isLongEnough = p.question.length >= 10 && p.answer.length >= 20;
                // Must not be just keywords without structure
                const hasStructure = p.question.includes(' ') && (
                    p.question.toLowerCase().startsWith('what') ||
                    p.question.toLowerCase().startsWith('who') ||
                    p.question.toLowerCase().startsWith('why') ||
                    p.question.toLowerCase().startsWith('tell')
                );

                return hasCompleteWords && isLongEnough && hasStructure;
            });

            // DEDUPLICATION: Remove duplicate questions
            const seen = new Set();
            const deduplicated = validPairs.filter(p => {
                const normalized = p.question.toLowerCase().trim();
                if (seen.has(normalized)) return false;
                seen.add(normalized);
                return true;
            });

            return deduplicated;
        }

        // Process uploaded text
        async function processTextUpload(text) {
            if (!text || text.trim().length < 50) {
                uploadStatus.textContent = '‚ö†Ô∏è Text too short (minimum 50 characters)';
                uploadStatus.style.color = '#dc2626';
                return;
            }

            try {
                processTextBtn.disabled = true;
                uploadProgress.style.display = 'block';
                uploadStatus.textContent = 'Processing...';
                uploadStatus.style.color = '#78350f';

                // Chunk the text
                const chunks = intelligentChunk(text);
                console.log(`\nüìÑ TEXT UPLOAD PROCESSING`);
                console.log(`   Total text length: ${text.length} characters`);
                console.log(`   Split into ${chunks.length} chunks\n`);

                let totalPairs = 0;
                let processed = 0;

                for (let i = 0; i < chunks.length; i++) {
                    const chunk = chunks[i];

                    // Generate Q&A pairs from chunk
                    const qaPairs = generateQAPairsFromChunk(chunk, i);

                    console.log(`üì¶ Chunk ${i + 1}/${chunks.length}:`);
                    console.log(`   Text preview: "${chunk.substring(0, 100)}..."`);
                    console.log(`   Generated ${qaPairs.length} Q&A pairs:`);

                    // Save each pair with embeddings
                    for (let j = 0; j < qaPairs.length; j++) {
                        const qa = qaPairs[j];

                        console.log(`   ${j + 1}. Q: "${qa.question}"`);
                        console.log(`      A: "${qa.answer.substring(0, 80)}${qa.answer.length > 80 ? '...' : ''}"`);

                        await saveQAPair(
                            qa.question,
                            qa.answer,
                            'up', // Pre-approved knowledge
                            {
                                source: 'text_upload',
                                chunk_index: i,
                                total_chunks: chunks.length,
                                upload_timestamp: Date.now()
                            }
                        );
                        totalPairs++;
                    }

                    if (qaPairs.length === 0) {
                        console.log(`   ‚ö†Ô∏è No valid Q&A pairs generated from this chunk`);
                    }
                    console.log('');

                    processed++;
                    const progress = Math.round((processed / chunks.length) * 100);
                    uploadProgressBar.style.width = progress + '%';
                    uploadProgressText.textContent = `Processing chunk ${processed}/${chunks.length}...`;

                    // Small delay to prevent UI freeze
                    await new Promise(resolve => setTimeout(resolve, 50));
                }

                console.log(`‚úÖ TEXT UPLOAD COMPLETE: ${totalPairs} total Q&A pairs\n`);

                // Success!
                uploadProgressBar.style.width = '100%';
                uploadProgressText.textContent = 'Complete!';
                uploadStatus.textContent = `‚úÖ Added ${totalPairs} Q&A pairs from ${chunks.length} chunks`;
                uploadStatus.style.color = '#15803d';

                // Clear textarea
                textUpload.value = '';

                // Update analytics
                await updateAnalytics();

                // Hide progress after 3 seconds
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                    uploadProgressBar.style.width = '0%';
                    uploadStatus.textContent = '';
                }, 3000);

                showLearningNotification(`üéâ Knowledge base expanded! Added ${totalPairs} new examples!`);

            } catch (error) {
                console.error('Text upload error:', error);
                uploadStatus.textContent = '‚ùå Processing failed! See console.';
                uploadStatus.style.color = '#dc2626';
            } finally {
                processTextBtn.disabled = false;
            }
        }

        // Event listener for text upload
        processTextBtn.addEventListener('click', async function() {
            const text = textUpload.value;
            await processTextUpload(text);
        });

        // ======================
        // DEBUG TOOLS
        // ======================

        // Clear Learnings Button
        clearLearningsBtn.addEventListener('click', async function() {
            if (!confirm('‚ö†Ô∏è This will delete ALL Q&A pairs from your knowledge base. Continue?')) {
                return;
            }

            try {
                // Get all docs and delete them
                const result = await learningDB.allDocs();
                const docsToDelete = result.rows.map(row => ({
                    _id: row.id,
                    _rev: row.value.rev,
                    _deleted: true
                }));
                await learningDB.bulkDocs(docsToDelete);

                await updateAnalytics();
                showLearningNotification('üóëÔ∏è All learnings cleared!');
                console.log('‚úÖ Knowledge base cleared');
            } catch (error) {
                console.error('‚ùå Error clearing database:', error);
                alert('Failed to clear database. See console for details.');
            }
        });

        // Update rating for existing Q&A pair by ID
        async function updateQAPairRating(id, newRating) {
            try {
                // Get the document first
                const doc = await learningDB.get(id);

                // Update the rating
                doc.rating = newRating;

                // Save it back
                await learningDB.put(doc);

                await updateAnalytics();
                const ratingEmoji = newRating === 'star3' ? '‚≠ê‚≠ê‚≠ê' :
                                   newRating === 'star2' ? '‚≠ê‚≠ê' :
                                   newRating === 'star1' ? '‚≠ê' : 'üëé';
                showLearningNotification(`${ratingEmoji} Rating updated!`);
                console.log(`‚úÖ Updated entry ${id} to rating: ${newRating}`);
                return true;
            } catch (error) {
                console.error('‚ùå Error updating rating:', error);
                alert('Failed to update rating. See console for details.');
                return false;
            }
        }

        // Delete single Q&A pair by ID
        async function deleteQAPair(id) {
            if (!confirm('üóëÔ∏è Delete this Q&A pair? This cannot be undone.')) {
                return false;
            }

            try {
                // Get the document first to get its _rev
                const doc = await learningDB.get(id);

                // Delete it
                await learningDB.remove(doc);

                await updateAnalytics();
                showLearningNotification('üóëÔ∏è Entry deleted!');
                console.log(`‚úÖ Deleted entry ID: ${id}`);
                return true;
            } catch (error) {
                console.error('‚ùå Error deleting entry:', error);
                alert('Failed to delete entry. See console for details.');
                return false;
            }
        }

        // Enrichment generation function
        async function generateEnrichments(originalQuestion, originalAnswer) {
            console.log('üé® Generating enrichments for:', originalQuestion);

            // Use creativity slider value (boost it for better variations)
            const enrichmentTemp = Math.max(1.0, creativityLevel + 0.3); // Minimum 1.0 for variations
            console.log(`üé® Using enrichment temperature: ${enrichmentTemp.toFixed(1)} (base: ${creativityLevel.toFixed(1)})`);

            const variations = [];

            // STRATEGY: Generate variations ONE AT A TIME (more reliable than batch)
            for (let i = 0; i < 3; i++) {
                try {
                    // Simple, focused prompt for single variation
                    const singlePrompt = `Rewrite this Q&A using completely different words but keep the exact same meaning and facts.

Original:
Q: ${originalQuestion}
A: ${originalAnswer}

Rewritten version (change words but NOT facts):
Q: `;

                    // Use experimental parameters for enrichment (with boosted temperature)
                    const enrichmentParams = {
                        messages: [{ role: 'user', content: singlePrompt }],
                        temperature: enrichmentTemp,  // Use boosted creativity
                        max_tokens: Math.max(400, expMaxTokens), // At least 400 for enrichment
                        repetition_penalty: autoAdjustParams ? 1.4 : expRepetitionPenalty,
                        frequency_penalty: autoAdjustParams ? 0.5 : expFrequencyPenalty,
                        top_p: autoAdjustParams ? 0.95 : expTopP
                    };

                    if (expPresencePenalty > 0 && !autoAdjustParams) {
                        enrichmentParams.presence_penalty = expPresencePenalty;
                    }

                    const response = await engine.chat.completions.create(enrichmentParams);

                    const rawOutput = response.choices[0].message.content.trim();
                    console.log(`ü§ñ Variation ${i+1} raw output:`, rawOutput.substring(0, 100) + '...');

                    // Parse the output - look for Q: and A: markers
                    let parsedQ = null;
                    let parsedA = null;

                    // Try to extract Q and A from output
                    const qMatch = rawOutput.match(/^(.+?)(?:\s*A:|$)/i);
                    if (qMatch) {
                        parsedQ = qMatch[1].trim();
                        // Remove "Q:" prefix if present
                        parsedQ = parsedQ.replace(/^Q:\s*/i, '').trim();
                    }

                    const aMatch = rawOutput.match(/A:\s*(.+)$/is);
                    if (aMatch) {
                        parsedA = aMatch[1].trim();
                    } else if (parsedQ && rawOutput.includes('\n')) {
                        // If no "A:" marker, try taking everything after the question
                        const parts = rawOutput.split('\n').filter(p => p.trim());
                        if (parts.length > 1) {
                            parsedA = parts.slice(1).join(' ').trim();
                        }
                    }

                    // Fallback: if parsing failed, use heuristic
                    if (!parsedQ && !parsedA && rawOutput.length > 10) {
                        // Assume output is answer continuation from "Q: " in prompt
                        const sentences = rawOutput.split(/[.!?]+/).filter(s => s.trim());
                        if (sentences.length >= 2) {
                            parsedQ = sentences[0].trim();
                            parsedA = sentences.slice(1).join('. ').trim();
                        } else {
                            // Just use the whole output as answer with slightly modified question
                            parsedQ = originalQuestion.replace(/what/i, 'tell me').replace(/\?$/, '') + '?';
                            parsedA = rawOutput;
                        }
                    }

                    // Validate: must have both Q and A, and not be too short
                    if (parsedQ && parsedA && parsedQ.length >= 5 && parsedA.length >= 15) {
                        // Check if it's too similar to original (prevent exact copies)
                        const qSimilar = parsedQ.toLowerCase() === originalQuestion.toLowerCase();
                        const aSimilar = parsedA.toLowerCase() === originalAnswer.toLowerCase();

                        if (!qSimilar || !aSimilar) {
                            variations.push({
                                question: parsedQ,
                                answer: parsedA,
                                isExactCopy: false
                            });
                            console.log(`‚úÖ Variation ${i+1} parsed successfully`);
                        } else {
                            console.warn(`‚ö†Ô∏è Variation ${i+1} is identical to original - marking as copy`);
                            variations.push({
                                question: parsedQ,
                                answer: parsedA,
                                isExactCopy: true
                            });
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è Variation ${i+1} failed validation - using fallback`);
                        // Use fallback with slight modification
                        variations.push({
                            question: originalQuestion,
                            answer: originalAnswer,
                            isExactCopy: true
                        });
                    }

                } catch (error) {
                    console.error(`‚ùå Error generating variation ${i+1}:`, error);
                    // Fallback on error
                    variations.push({
                        question: originalQuestion,
                        answer: originalAnswer,
                        isExactCopy: true
                    });
                }

                // Small delay between generations to avoid rate limits
                if (i < 2) await new Promise(resolve => setTimeout(resolve, 100));
            }

            // Check if all variations are identical
            const allIdentical = variations.every(v => v.isExactCopy);
            if (allIdentical) {
                console.warn('‚ö†Ô∏è All variations are identical or failed - TinyLlama struggled with this task');
                console.warn('üí° Tip: Try increasing Creativity slider (‚öôÔ∏è Advanced Controls) for better variations');
            }

            return variations.map(v => ({ question: v.question, answer: v.answer }));
        }

        // Show enrichments in modal
        let currentEnrichments = [];
        let currentEnrichmentContext = { question: '', answer: '' };

        async function generateAndShowEnrichments(question, answer) {
            // Show modal with loading state
            const modal = document.getElementById('enrichmentModal');
            const content = document.getElementById('enrichmentContent');
            content.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 32px; margin-bottom: 10px;">‚ú®</div>
                    <p>Generating variations...</p>
                    <p style="font-size: 12px; margin-top: 10px;">This may take a few seconds</p>
                </div>
            `;
            modal.style.display = 'flex';

            try {
                // Generate enrichments
                const variations = await generateEnrichments(question, answer);
                currentEnrichments = variations.map((v, i) => ({ ...v, approved: true, id: i }));
                currentEnrichmentContext = { question, answer };

                // Check if all variations are identical to original
                const allIdentical = variations.every(v =>
                    v.question.toLowerCase() === question.toLowerCase() &&
                    v.answer.toLowerCase() === answer.toLowerCase()
                );

                // Display variations
                let html = `
                    <div style="background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                        <div style="font-weight: bold; color: #166534; margin-bottom: 8px;">üìù Original Q&A</div>
                        <div style="margin-bottom: 8px;"><strong>Q:</strong> ${question}</div>
                        <div><strong>A:</strong> ${answer}</div>
                    </div>`;

                // Show warning if all variations are identical
                if (allIdentical) {
                    html += `
                        <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="font-weight: bold; color: #78350f; margin-bottom: 8px;">‚ö†Ô∏è Low Variation Quality</div>
                            <div style="font-size: 13px; color: #92400e; margin-bottom: 8px;">
                                TinyLlama couldn't generate different variations - all 3 are identical to the original.
                            </div>
                            <div style="font-size: 12px; color: #92400e;">
                                üí° <strong>Tip:</strong> Try increasing the <strong>üé® Creativity slider</strong> in Advanced Controls (‚öôÔ∏è), then click ‚ú® Enrich again.
                            </div>
                        </div>`;
                }

                html += `<div style="font-weight: bold; margin-bottom: 15px; color: #374151;">‚ú® Generated Variations:</div>`;

                currentEnrichments.forEach((variation, i) => {
                    html += `
                        <div class="enrichment-variation" data-id="${i}" style="
                            border: 2px solid ${variation.approved ? '#10b981' : '#ef4444'};
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 15px;
                            background: ${variation.approved ? '#f0fdf4' : '#fef2f2'};
                            transition: all 0.2s;
                        ">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div style="font-weight: bold; color: #374151;">Variation ${i + 1}</div>
                                <button class="toggle-approval-btn" data-id="${i}" style="
                                    background: ${variation.approved ? '#10b981' : '#ef4444'};
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    padding: 6px 12px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    transition: all 0.2s;
                                ">
                                    ${variation.approved ? '‚úì Approved' : '‚úó Rejected'}
                                </button>
                            </div>
                            <div style="margin-bottom: 8px;"><strong>Q:</strong> ${variation.question}</div>
                            <div><strong>A:</strong> ${variation.answer}</div>
                        </div>
                    `;
                });

                content.innerHTML = html;

                // Add event listeners for approval toggle
                document.querySelectorAll('.toggle-approval-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        currentEnrichments[id].approved = !currentEnrichments[id].approved;

                        // Update UI
                        const variation = document.querySelector(`.enrichment-variation[data-id="${id}"]`);
                        const isApproved = currentEnrichments[id].approved;

                        variation.style.border = `2px solid ${isApproved ? '#10b981' : '#ef4444'}`;
                        variation.style.background = isApproved ? '#f0fdf4' : '#fef2f2';
                        this.style.background = isApproved ? '#10b981' : '#ef4444';
                        this.innerHTML = isApproved ? '‚úì Approved' : '‚úó Rejected';
                    });
                });

            } catch (error) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <div style="font-size: 32px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <p><strong>Error generating enrichments</strong></p>
                        <p style="font-size: 12px; margin-top: 10px;">${error.message}</p>
                    </div>
                `;
            }
        }

        // Save approved enrichments
        async function saveApprovedEnrichments() {
            const approved = currentEnrichments.filter(e => e.approved);

            if (approved.length === 0) {
                alert('No variations approved. Please approve at least one variation.');
                return;
            }

            try {
                // Save each approved variation
                for (const variation of approved) {
                    await saveQAPair(variation.question, variation.answer, 'star2', {
                        source: 'enrichment',
                        original_question: currentEnrichmentContext.question,
                        original_answer: currentEnrichmentContext.answer
                    });
                }

                // Close modal
                document.getElementById('enrichmentModal').style.display = 'none';

                // Show notification
                const stats = await getLearningStats();
                showLearningNotification(`‚ú® Saved ${approved.length} enrichment${approved.length > 1 ? 's' : ''}! (${stats.total} total)`);

                console.log(`‚úÖ Saved ${approved.length} enrichments to database`);
            } catch (error) {
                console.error('‚ùå Error saving enrichments:', error);
                alert('Failed to save enrichments. See console for details.');
            }
        }

        // View Database Button
        viewDatabaseBtn.addEventListener('click', async function() {
            await loadAndDisplayDatabase();
        });

        // Function to load and display database (separated for reuse after delete)
        async function loadAndDisplayDatabase() {
            try {
                // Get all Q&A pairs from PouchDB
                const result = await learningDB.allDocs({ include_docs: true });
                const pairsWithIds = result.rows
                    .map(row => ({ id: row.id, ...row.doc }))
                    .filter(doc => doc.type === 'question-answer');

                const content = document.getElementById('databaseContent');
                if (pairsWithIds.length === 0) {
                    content.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No Q&A pairs in database yet.</p>';
                } else {
                    const star3Count = pairsWithIds.filter(p => p.rating === 'star3').length;
                    const star2Count = pairsWithIds.filter(p => p.rating === 'star2').length;
                    const star1Count = pairsWithIds.filter(p => p.rating === 'star1').length;
                    const downCount = pairsWithIds.filter(p => p.rating === 'down').length;
                    const legacyUp = pairsWithIds.filter(p => p.rating === 'up').length;

                    let html = `
                        <div style="margin-bottom: 15px; padding: 10px; background: #f3f4f6; border-radius: 8px;">
                            <strong>Total Entries:</strong> ${pairsWithIds.length} |
                            <strong>‚≠ê‚≠ê‚≠ê:</strong> ${star3Count} |
                            <strong>‚≠ê‚≠ê:</strong> ${star2Count} |
                            <strong>‚≠ê:</strong> ${star1Count} |
                            <strong>üëé:</strong> ${downCount}
                            ${legacyUp > 0 ? `| <strong>üëç (old):</strong> ${legacyUp}` : ''}
                        </div>
                        <div style="display: grid; gap: 10px;" id="databaseEntries">
                    `;

                    pairsWithIds.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                    pairsWithIds.forEach((p, i) => {
                        const date = p.timestamp ? new Date(p.timestamp).toLocaleString() : 'Unknown';
                        const rating = p.rating === 'star3' ? '‚≠ê‚≠ê‚≠ê' :
                                      p.rating === 'star2' ? '‚≠ê‚≠ê' :
                                      p.rating === 'star1' ? '‚≠ê' :
                                      p.rating === 'down' ? 'üëé' :
                                      p.rating === 'up' ? 'üëç' : '‚ö™';
                        const borderColor = p.rating === 'star3' ? '#fbbf24' :
                                           p.rating === 'star2' || p.rating === 'up' ? '#10b981' :
                                           p.rating === 'star1' ? '#fb923c' :
                                           p.rating === 'down' ? '#ef4444' : '#9ca3af';
                        const category = p.category || detectCategory(p.question);
                        const source = p.source || 'manual';
                        const hasEmbedding = p.embedding ? 'üß†' : 'üî§';
                        const tags = p.tags || [];
                        const tagsHTML = tags.length > 0 ?
                            `<div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px;">
                                ${tags.map(tag => `<span style="background: linear-gradient(135deg, #e0e7ff 0%, #ddd6fe 100%); color: #5b21b6; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 500;">${tag}</span>`).join('')}
                            </div>` : '';

                        html += `
                            <div style="border: 1px solid #e5e7eb; border-left: 4px solid ${borderColor}; padding: 12px; border-radius: 8px; background: white;" data-id="${p.id}">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 11px; color: #666;">
                                    <span>${rating} ${hasEmbedding} <strong style="color: #333;">#${i + 1}</strong> | ${category} | ${source}</span>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span>${date}</span>
                                        <button class="delete-entry-btn" data-id="${p.id}" style="background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; transition: all 0.2s;" title="Delete this entry">
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <strong style="color: #8b5cf6;">Q:</strong> <span style="color: #333;">${p.question}</span>
                                </div>
                                <div style="color: #666; font-size: 13px; margin-bottom: 8px;">
                                    <strong style="color: #8b5cf6;">A:</strong> ${p.answer}
                                </div>
                                ${tagsHTML}
                                <div style="display: flex; gap: 6px; padding-top: 8px; margin-top: 8px; border-top: 1px solid rgba(0,0,0,0.05); justify-content: flex-end;">
                                    <button class="rating-change-btn" data-id="${p.id}" data-rating="star1" style="background: ${p.rating === 'star1' ? 'rgba(251, 146, 60, 0.3)' : 'rgba(255, 255, 255, 0.6)'}; border: 1px solid ${p.rating === 'star1' ? '#fb923c' : 'rgba(0,0,0,0.1)'}; border-radius: 4px; padding: 4px 8px; font-size: 14px; cursor: pointer; transition: all 0.2s;" title="Okay (0.8√ó weight)">‚≠ê</button>
                                    <button class="rating-change-btn" data-id="${p.id}" data-rating="star2" style="background: ${p.rating === 'star2' || p.rating === 'up' ? 'rgba(16, 185, 129, 0.2)' : 'rgba(255, 255, 255, 0.6)'}; border: 1px solid ${p.rating === 'star2' || p.rating === 'up' ? '#10b981' : 'rgba(0,0,0,0.1)'}; border-radius: 4px; padding: 4px 8px; font-size: 14px; cursor: pointer; transition: all 0.2s;" title="Good (1.0√ó weight)">‚≠ê‚≠ê</button>
                                    <button class="rating-change-btn" data-id="${p.id}" data-rating="star3" style="background: ${p.rating === 'star3' ? 'rgba(251, 191, 36, 0.3)' : 'rgba(255, 255, 255, 0.6)'}; border: 1px solid ${p.rating === 'star3' ? '#fbbf24' : 'rgba(0,0,0,0.1)'}; border-radius: 4px; padding: 4px 8px; font-size: 14px; cursor: pointer; transition: all 0.2s;" title="Excellent (1.2√ó weight)">‚≠ê‚≠ê‚≠ê</button>
                                    <button class="rating-change-btn" data-id="${p.id}" data-rating="down" style="background: ${p.rating === 'down' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(255, 255, 255, 0.6)'}; border: 1px solid ${p.rating === 'down' ? '#ef4444' : 'rgba(0,0,0,0.1)'}; border-radius: 4px; padding: 4px 8px; font-size: 14px; cursor: pointer; transition: all 0.2s;" title="Bad (excluded)">üëé</button>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    content.innerHTML = html;

                    // Add event listeners to all delete buttons
                    document.querySelectorAll('.delete-entry-btn').forEach(btn => {
                        btn.addEventListener('click', async function(e) {
                            e.stopPropagation();
                            const id = this.getAttribute('data-id'); // PouchDB uses string IDs
                            const deleted = await deleteQAPair(id);
                            if (deleted) {
                                // Refresh the database view
                                await loadAndDisplayDatabase();
                            }
                        });

                        // Hover effect
                        btn.addEventListener('mouseenter', function() {
                            this.style.background = '#ef4444';
                            this.style.color = 'white';
                            this.style.borderColor = '#dc2626';
                        });
                        btn.addEventListener('mouseleave', function() {
                            this.style.background = '#fee2e2';
                            this.style.color = '#991b1b';
                            this.style.borderColor = '#fecaca';
                        });
                    });

                    // Add event listeners to all rating change buttons
                    document.querySelectorAll('.rating-change-btn').forEach(btn => {
                        btn.addEventListener('click', async function(e) {
                            e.stopPropagation();
                            const id = this.getAttribute('data-id'); // PouchDB uses string IDs
                            const newRating = this.getAttribute('data-rating');
                            const updated = await updateQAPairRating(id, newRating);
                            if (updated) {
                                // Refresh the database view to show updated styling
                                await loadAndDisplayDatabase();
                            }
                        });

                        // Hover effect
                        btn.addEventListener('mouseenter', function() {
                            this.style.transform = 'scale(1.1)';
                            this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
                        });
                        btn.addEventListener('mouseleave', function() {
                            this.style.transform = 'scale(1)';
                            this.style.boxShadow = 'none';
                        });
                    });
                }

                document.getElementById('databaseModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading database:', error);
                alert('Failed to load database. See console for details.');
            }
        }

        document.getElementById('closeDatabaseBtn').addEventListener('click', function() {
            document.getElementById('databaseModal').style.display = 'none';
        });

        // Enrichment Modal Event Listeners
        document.getElementById('closeEnrichmentBtn').addEventListener('click', function() {
            document.getElementById('enrichmentModal').style.display = 'none';
        });

        document.getElementById('cancelEnrichmentBtn').addEventListener('click', function() {
            document.getElementById('enrichmentModal').style.display = 'none';
        });

        document.getElementById('saveEnrichmentsBtn').addEventListener('click', async function() {
            await saveApprovedEnrichments();
        });

        // RAG Inspector Toggle
        let ragInspectorActive = false;
        toggleRAGInspectorBtn.addEventListener('click', function() {
            ragInspectorActive = !ragInspectorActive;
            document.getElementById('ragInspector').style.display = ragInspectorActive ? 'block' : 'none';
            toggleRAGInspectorBtn.textContent = ragInspectorActive ? 'üîç Hide Inspector' : 'üîç RAG Inspector';
        });

        document.getElementById('closeRAGInspectorBtn').addEventListener('click', function() {
            ragInspectorActive = false;
            document.getElementById('ragInspector').style.display = 'none';
            toggleRAGInspectorBtn.textContent = 'üîç RAG Inspector';
        });

        // Console Log Viewer
        const consoleLogs = [];
        let consoleViewerActive = false;

        // Intercept console.log
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logText = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleLogs.push({ type: 'log', text: logText, time: new Date() });
            if (consoleLogs.length > 100) consoleLogs.shift(); // Keep last 100
            if (consoleViewerActive) updateConsoleViewer();
        };

        // Also intercept console.warn and console.error
        const originalWarn = console.warn;
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            const logText = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleLogs.push({ type: 'warn', text: logText, time: new Date() });
            if (consoleLogs.length > 100) consoleLogs.shift();
            if (consoleViewerActive) updateConsoleViewer();
        };

        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            const logText = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleLogs.push({ type: 'error', text: logText, time: new Date() });
            if (consoleLogs.length > 100) consoleLogs.shift();
            if (consoleViewerActive) updateConsoleViewer();
        };

        function updateConsoleViewer() {
            const content = document.getElementById('consoleContent');
            const html = consoleLogs.map(log => {
                const time = log.time.toLocaleTimeString();
                const color = log.type === 'error' ? '#ef4444' : log.type === 'warn' ? '#f59e0b' : '#10b981';
                return `<div style="margin-bottom: 4px; border-bottom: 1px solid rgba(16, 185, 129, 0.1); padding-bottom: 4px;">
                    <span style="color: #666;">[${time}]</span> <span style="color: ${color};">${log.text}</span>
                </div>`;
            }).join('');
            content.innerHTML = html || '<div style="color: #666; text-align: center; padding: 20px;">No logs yet</div>';
            content.scrollTop = content.scrollHeight; // Auto-scroll to bottom
        }

        toggleConsoleLogBtn.addEventListener('click', function() {
            consoleViewerActive = !consoleViewerActive;
            document.getElementById('consoleViewer').style.display = consoleViewerActive ? 'block' : 'none';
            toggleConsoleLogBtn.textContent = consoleViewerActive ? 'üìú Hide Console' : 'üìú Console Viewer';
            if (consoleViewerActive) updateConsoleViewer();
        });

        document.getElementById('closeConsoleBtn').addEventListener('click', function() {
            consoleViewerActive = false;
            document.getElementById('consoleViewer').style.display = 'none';
            toggleConsoleLogBtn.textContent = 'üìú Console Viewer';
        });

        document.getElementById('clearConsoleBtn').addEventListener('click', function() {
            consoleLogs.length = 0;
            updateConsoleViewer();
        });

        // ========================================
        // ADVANCED CONTROLS FUNCTIONALITY
        // ========================================

        // Load settings from localStorage
        function loadAdvancedSettings() {
            const saved = localStorage.getItem('advancedSettings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    creativityLevel = settings.creativity || 0.7;
                    ragInfluence = settings.ragInfluence || 0.5;
                    minRAGTemperature = settings.minRAGTemperature || 0.4;
                    currentSystemPrompt = settings.systemPrompt || DEFAULT_SYSTEM_PROMPT;

                    // Update UI
                    document.getElementById('creativitySlider').value = creativityLevel;
                    document.getElementById('creativityValue').textContent = creativityLevel.toFixed(1);
                    document.getElementById('ragInfluenceSlider').value = ragInfluence;
                    document.getElementById('ragInfluenceValue').textContent = ragInfluence.toFixed(1);
                    document.getElementById('minRagTempSlider').value = minRAGTemperature;
                    document.getElementById('minRagTempValue').textContent = minRAGTemperature.toFixed(1);
                    document.getElementById('systemPromptEditor').value = currentSystemPrompt;

                    console.log('‚úÖ Loaded advanced settings:', settings);
                } catch (e) {
                    console.error('‚ùå Failed to load advanced settings:', e);
                }
            } else {
                // Initialize UI with defaults
                document.getElementById('systemPromptEditor').value = DEFAULT_SYSTEM_PROMPT;
            }
        }

        // Save settings to localStorage
        function saveAdvancedSettings() {
            const settings = {
                creativity: creativityLevel,
                ragInfluence: ragInfluence,
                minRAGTemperature: minRAGTemperature,
                systemPrompt: currentSystemPrompt
            };
            localStorage.setItem('advancedSettings', JSON.stringify(settings));
            console.log('üíæ Saved advanced settings:', settings);
            showLearningNotification('üíæ Settings saved!');
        }

        // Collapse/expand toggle
        let advancedControlsExpanded = true;
        document.getElementById('advancedControlsHeader').addEventListener('click', function() {
            advancedControlsExpanded = !advancedControlsExpanded;
            document.getElementById('advancedControlsContent').style.display = advancedControlsExpanded ? 'block' : 'none';
            document.getElementById('advancedControlsToggle').textContent = advancedControlsExpanded ? '‚ñº' : '‚ñ∂';
        });

        // Creativity slider
        const creativitySlider = document.getElementById('creativitySlider');
        const creativityValue = document.getElementById('creativityValue');
        creativitySlider.addEventListener('input', function() {
            creativityLevel = parseFloat(this.value);
            creativityValue.textContent = creativityLevel.toFixed(1);
            console.log(`üé® Creativity level: ${creativityLevel}`);
        });

        // RAG Influence slider
        const ragInfluenceSlider = document.getElementById('ragInfluenceSlider');
        const ragInfluenceValue = document.getElementById('ragInfluenceValue');
        ragInfluenceSlider.addEventListener('input', function() {
            ragInfluence = parseFloat(this.value);
            ragInfluenceValue.textContent = ragInfluence.toFixed(1);
            console.log(`üß† RAG influence: ${ragInfluence}`);
        });

        // Minimum RAG Temperature slider
        const minRagTempSlider = document.getElementById('minRagTempSlider');
        const minRagTempValue = document.getElementById('minRagTempValue');
        minRagTempSlider.addEventListener('input', function() {
            minRAGTemperature = parseFloat(this.value);
            minRagTempValue.textContent = minRAGTemperature.toFixed(1);
            const statusText = minRAGTemperature <= 0.2 ? 'DISABLED' :
                              minRAGTemperature >= 0.6 ? 'STRICT' : 'BALANCED';
            console.log(`üå°Ô∏è Min RAG temperature: ${minRAGTemperature} (${statusText})`);
        });

        // System Prompt editor
        const systemPromptEditor = document.getElementById('systemPromptEditor');
        systemPromptEditor.addEventListener('input', function() {
            currentSystemPrompt = this.value;
            console.log('üìù System prompt updated');
        });

        // Reset prompt button
        document.getElementById('resetPromptBtn').addEventListener('click', function() {
            currentSystemPrompt = DEFAULT_SYSTEM_PROMPT;
            systemPromptEditor.value = DEFAULT_SYSTEM_PROMPT;
            console.log('üîÑ System prompt reset to default');
            showLearningNotification('üîÑ Prompt reset to default');
        });

        // Save settings button
        document.getElementById('saveAdvancedSettings').addEventListener('click', function() {
            saveAdvancedSettings();
        });

        // Load settings on page load
        loadAdvancedSettings();

        // Update RAG Inspector with search results
        function updateRAGInspector(query, results, strategy) {
            if (!ragInspectorActive) return;

            const content = document.getElementById('ragInspectorContent');
            let html = `<strong>Query:</strong> "${query}"\n\n`;

            if (results.length === 0) {
                html += '<span style="color: #ef4444;">‚ö†Ô∏è No RAG matches found</span>\n\n';
            } else {
                html += `<strong>Matches Found:</strong> ${results.length}\n\n`;
                results.forEach((r, i) => {
                    html += `<div style="background: #f3f4f6; padding: 8px; margin-bottom: 8px; border-radius: 4px;">`;
                    html += `<strong>#${i + 1}</strong> Score: ${r.similarity.toFixed(3)}\n`;
                    html += `Q: "${r.question}"\n`;
                    html += `A: "${r.answer.substring(0, 80)}${r.answer.length > 80 ? '...' : ''}"\n`;
                    html += `</div>`;
                });
            }

            html += `\n<strong>Strategy:</strong> ${strategy}`;
            content.innerHTML = `<pre style="margin: 0;">${html}</pre>`;
        }

        // File upload and import
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) await importTrainingData(file);
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) await importTrainingData(file);
        });

        async function importTrainingData(file) {
            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (!data.pairs || !Array.isArray(data.pairs)) {
                    throw new Error('Invalid training data format');
                }

                let imported = 0;
                for (const pair of data.pairs) {
                    if (pair.question && pair.answer) {
                        await saveQAPair(pair.question, pair.answer, pair.rating || 'up');
                        imported++;
                    }
                }

                await updateAnalytics();
                showLearningNotification(`üìÇ Imported ${imported} training pairs!`);
            } catch (error) {
                console.error('Import error:', error);
                showLearningNotification('‚ùå Failed to import training data!');
            }
        }

        // Rocket click handler
        trainingRocket.addEventListener('click', async function() {
            const isActive = trainingPanel.classList.contains('active');
            if (!isActive) {
                trainingPanel.classList.add('active');
                if (!learningDB) await initLearningDB();
                await updateAnalytics();
            } else {
                trainingPanel.classList.remove('active');
            }
        });

        // Close panel
        closePanelBtn.addEventListener('click', function() {
            trainingPanel.classList.remove('active');
        });

        // Update analytics when learning happens
        const originalSaveQAPair = saveQAPair;
        window.saveQAPair = async function(...args) {
            const result = await originalSaveQAPair(...args);
            await updateAnalytics();
            return result;
        };

        // ==================== EXPERIMENTAL PARAMETERS UI ====================

        // Get all experimental parameter elements
        const autoAdjustToggle = document.getElementById('autoAdjustToggle');
        const topPSlider = document.getElementById('topPSlider');
        const topKSlider = document.getElementById('topKSlider');
        const freqPenaltySlider = document.getElementById('freqPenaltySlider');
        const presPenaltySlider = document.getElementById('presPenaltySlider');
        const repPenaltySlider = document.getElementById('repPenaltySlider');
        const maxTokensSlider = document.getElementById('maxTokensSlider');
        const seedInput = document.getElementById('seedInput');

        // Value display elements
        const topPValue = document.getElementById('topPValue');
        const topKValue = document.getElementById('topKValue');
        const freqPenaltyValue = document.getElementById('freqPenaltyValue');
        const presPenaltyValue = document.getElementById('presPenaltyValue');
        const repPenaltyValue = document.getElementById('repPenaltyValue');
        const maxTokensValue = document.getElementById('maxTokensValue');

        // Footer elements
        const footerTemp = document.getElementById('footerTemp');
        const footerTopP = document.getElementById('footerTopP');
        const footerTopPAuto = document.getElementById('footerTopPAuto');
        const footerTopK = document.getElementById('footerTopK');
        const footerFreq = document.getElementById('footerFreq');
        const footerPres = document.getElementById('footerPres');
        const footerRep = document.getElementById('footerRep');
        const footerRepAuto = document.getElementById('footerRepAuto');
        const footerMax = document.getElementById('footerMax');
        const footerSeed = document.getElementById('footerSeed');
        const footerSeedItem = document.getElementById('footerSeedItem');

        // Button elements
        const resetExperimentalBtn = document.getElementById('resetExperimentalBtn');
        const presetDeterministicBtn = document.getElementById('presetDeterministicBtn');
        const presetCreativeBtn = document.getElementById('presetCreativeBtn');
        const useTimestampBtn = document.getElementById('useTimestampBtn');
        const toggleFooterBtn = document.getElementById('toggleFooterBtn');
        const experimentalParamsHeader = document.getElementById('experimentalParamsHeader');
        const experimentalParamsToggle = document.getElementById('experimentalParamsToggle');
        const experimentalParamsContent = document.getElementById('experimentalParamsContent');

        // Function to update live preview footer
        function updateLivePreview(highlightParam = null) {
            // Update temperature (from creativity slider)
            footerTemp.textContent = creativityLevel.toFixed(1);

            // Update top_p
            footerTopP.textContent = expTopP.toFixed(2);
            footerTopPAuto.style.display = autoAdjustParams ? 'inline' : 'none';

            // Update top_k
            footerTopK.textContent = expTopK === 0 ? '0' : expTopK;

            // Update penalties
            footerFreq.textContent = expFrequencyPenalty.toFixed(1);
            footerPres.textContent = expPresencePenalty.toFixed(1);
            footerRep.textContent = expRepetitionPenalty.toFixed(2);
            footerRepAuto.style.display = autoAdjustParams ? 'inline' : 'none';

            // Update max tokens
            footerMax.textContent = expMaxTokens;

            // Update seed
            if (expSeed !== null) {
                footerSeed.textContent = expSeed;
                footerSeedItem.style.display = 'flex';
            } else {
                footerSeedItem.style.display = 'none';
            }

            // Highlight changed parameter
            if (highlightParam) {
                const paramElement = document.querySelector(`#footer${highlightParam}`);
                if (paramElement) {
                    const parentItem = paramElement.closest('.param-item');
                    parentItem.classList.add('changed');
                    setTimeout(() => parentItem.classList.remove('changed'), 500);
                }
            }
        }

        // Auto-adjust toggle
        autoAdjustToggle.addEventListener('change', function() {
            autoAdjustParams = this.checked;
            console.log(`üîÑ Auto-adjust: ${autoAdjustParams ? 'enabled' : 'disabled'}`);
            updateLivePreview();
        });

        // Top-P slider
        topPSlider.addEventListener('input', function() {
            expTopP = parseFloat(this.value);
            topPValue.textContent = expTopP.toFixed(2);
            updateLivePreview('TopP');
            console.log(`üéØ Top-P: ${expTopP.toFixed(2)}`);
        });

        // Top-K slider
        topKSlider.addEventListener('input', function() {
            expTopK = parseInt(this.value);
            topKValue.textContent = expTopK === 0 ? '0 (disabled)' : expTopK;
            updateLivePreview('TopK');
            console.log(`üî¢ Top-K: ${expTopK}`);
        });

        // Frequency Penalty slider
        freqPenaltySlider.addEventListener('input', function() {
            expFrequencyPenalty = parseFloat(this.value);
            freqPenaltyValue.textContent = expFrequencyPenalty.toFixed(1);
            updateLivePreview('Freq');
            console.log(`üìä Frequency Penalty: ${expFrequencyPenalty.toFixed(1)}`);
        });

        // Presence Penalty slider
        presPenaltySlider.addEventListener('input', function() {
            expPresencePenalty = parseFloat(this.value);
            presPenaltyValue.textContent = expPresencePenalty.toFixed(1);
            updateLivePreview('Pres');
            console.log(`‚ú® Presence Penalty: ${expPresencePenalty.toFixed(1)}`);
        });

        // Repetition Penalty slider
        repPenaltySlider.addEventListener('input', function() {
            expRepetitionPenalty = parseFloat(this.value);
            repPenaltyValue.textContent = expRepetitionPenalty.toFixed(2);
            updateLivePreview('Rep');
            console.log(`üîÅ Repetition Penalty: ${expRepetitionPenalty.toFixed(2)}`);
        });

        // Max Tokens slider
        maxTokensSlider.addEventListener('input', function() {
            expMaxTokens = parseInt(this.value);
            maxTokensValue.textContent = expMaxTokens;
            updateLivePreview('Max');
            console.log(`üìè Max Tokens: ${expMaxTokens}`);
        });

        // Seed input
        seedInput.addEventListener('input', function() {
            const value = this.value.trim();
            expSeed = value === '' ? null : parseInt(value);
            updateLivePreview('Seed');
            console.log(`üé≤ Seed: ${expSeed === null ? 'none (random)' : expSeed}`);
        });

        // Use Timestamp button
        useTimestampBtn.addEventListener('click', function() {
            const timestamp = Date.now();
            seedInput.value = timestamp;
            expSeed = timestamp;
            updateLivePreview('Seed');
            console.log(`üé≤ Seed set to timestamp: ${timestamp}`);
        });

        // Reset button
        resetExperimentalBtn.addEventListener('click', function() {
            // Reset to defaults
            autoAdjustParams = true;
            expTopP = 0.9;
            expTopK = 0;
            expFrequencyPenalty = 0.3;
            expPresencePenalty = 0.0;
            expRepetitionPenalty = 1.15;
            expMaxTokens = 300;
            expSeed = null;

            // Update UI
            autoAdjustToggle.checked = true;
            topPSlider.value = 0.9;
            topPValue.textContent = '0.9';
            topKSlider.value = 0;
            topKValue.textContent = '0 (disabled)';
            freqPenaltySlider.value = 0.3;
            freqPenaltyValue.textContent = '0.3';
            presPenaltySlider.value = 0.0;
            presPenaltyValue.textContent = '0.0';
            repPenaltySlider.value = 1.15;
            repPenaltyValue.textContent = '1.15';
            maxTokensSlider.value = 300;
            maxTokensValue.textContent = '300';
            seedInput.value = '';

            updateLivePreview();
            console.log('üîÑ Reset all experimental parameters to defaults');
        });

        // Deterministic preset
        presetDeterministicBtn.addEventListener('click', function() {
            autoAdjustParams = false;
            creativityLevel = 0.1;
            expTopP = 0.5;
            expTopK = 5;
            expFrequencyPenalty = 0.0;
            expPresencePenalty = 0.0;
            expRepetitionPenalty = 1.0;
            expMaxTokens = 200;
            expSeed = 12345;

            // Update UI
            autoAdjustToggle.checked = false;
            creativitySlider.value = 0.1;
            creativityValue.textContent = '0.1';
            topPSlider.value = 0.5;
            topPValue.textContent = '0.50';
            topKSlider.value = 5;
            topKValue.textContent = '5';
            freqPenaltySlider.value = 0.0;
            freqPenaltyValue.textContent = '0.0';
            presPenaltySlider.value = 0.0;
            presPenaltyValue.textContent = '0.0';
            repPenaltySlider.value = 1.0;
            repPenaltyValue.textContent = '1.00';
            maxTokensSlider.value = 200;
            maxTokensValue.textContent = '200';
            seedInput.value = '12345';

            updateLivePreview();
            console.log('üéØ Applied DETERMINISTIC preset');
        });

        // Creative preset
        presetCreativeBtn.addEventListener('click', function() {
            autoAdjustParams = false;
            creativityLevel = 1.2;
            expTopP = 0.95;
            expTopK = 0;
            expFrequencyPenalty = 0.1;
            expPresencePenalty = 0.5;
            expRepetitionPenalty = 1.4;
            expMaxTokens = 500;
            expSeed = null;

            // Update UI
            autoAdjustToggle.checked = false;
            creativitySlider.value = 1.2;
            creativityValue.textContent = '1.2';
            topPSlider.value = 0.95;
            topPValue.textContent = '0.95';
            topKSlider.value = 0;
            topKValue.textContent = '0 (disabled)';
            freqPenaltySlider.value = 0.1;
            freqPenaltyValue.textContent = '0.1';
            presPenaltySlider.value = 0.5;
            presPenaltyValue.textContent = '0.5';
            repPenaltySlider.value = 1.4;
            repPenaltyValue.textContent = '1.40';
            maxTokensSlider.value = 500;
            maxTokensValue.textContent = '500';
            seedInput.value = '';

            updateLivePreview();
            console.log('üé® Applied CREATIVE preset');
        });

        // Toggle footer visibility
        let footerVisible = true;
        toggleFooterBtn.addEventListener('click', function() {
            footerVisible = !footerVisible;
            const footer = document.getElementById('paramPreviewFooter');
            if (footerVisible) {
                footer.style.display = 'flex';
                this.textContent = 'Hide';
            } else {
                footer.style.display = 'none';
                this.textContent = 'Show';
            }
        });

        // Toggle experimental params panel
        experimentalParamsHeader.addEventListener('click', function() {
            const isExpanded = experimentalParamsContent.style.display === 'block';
            experimentalParamsContent.style.display = isExpanded ? 'none' : 'block';
            experimentalParamsToggle.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
        });

        // Update creativity slider to also update live preview
        creativitySlider.addEventListener('input', function() {
            creativityLevel = parseFloat(this.value);
            creativityValue.textContent = creativityLevel.toFixed(1);
            updateLivePreview('Temp');

            // Log current temperature status
            let statusText = creativityLevel < 0.4 ? 'Conservative' :
                           creativityLevel > 1.0 ? 'Very Creative' : 'Balanced';
            console.log(`üé® Creativity (temperature): ${creativityLevel.toFixed(1)} (${statusText})`);
        });

        // Initialize live preview on page load
        updateLivePreview();

        console.log('üß™ Experimental Parameters UI initialized!');
        console.log(`üìä Current params: temp=${creativityLevel}, top_p=${expTopP}, top_k=${expTopK}, freq=${expFrequencyPenalty}, pres=${expPresencePenalty}, rep=${expRepetitionPenalty}, max=${expMaxTokens}`);

        // Initialize rocket display
        (async function() {
            if (!learningDB) await initLearningDB();
            await updateAnalytics();
        })();
    </script>

    <!-- Live Parameter Preview Footer -->
    <div class="param-preview-footer" id="paramPreviewFooter">
        <div class="param-group">
            <div class="param-item tooltip-hint" data-hint="Temperature (Creativity Level)">
                <span class="param-label">temp:</span>
                <span class="param-value" id="footerTemp">0.7</span>
            </div>
            <div class="param-item tooltip-hint" data-hint="Top-P (Nucleus Sampling)">
                <span class="param-label">top_p:</span>
                <span class="param-value" id="footerTopP">0.9</span>
                <span class="param-value auto" id="footerTopPAuto" style="display: none;">(auto)</span>
            </div>
            <div class="param-item tooltip-hint" data-hint="Top-K (disabled if 0)">
                <span class="param-label">top_k:</span>
                <span class="param-value" id="footerTopK">0</span>
            </div>
            <div class="param-item tooltip-hint" data-hint="Frequency Penalty">
                <span class="param-label">freq:</span>
                <span class="param-value" id="footerFreq">0.3</span>
            </div>
            <div class="param-item tooltip-hint" data-hint="Presence Penalty">
                <span class="param-label">pres:</span>
                <span class="param-value" id="footerPres">0.0</span>
            </div>
            <div class="param-item tooltip-hint" data-hint="Repetition Penalty (MLC)">
                <span class="param-label">rep:</span>
                <span class="param-value" id="footerRep">1.15</span>
                <span class="param-value auto" id="footerRepAuto" style="display: none;">(auto)</span>
            </div>
            <div class="param-item tooltip-hint" data-hint="Max Tokens (response length)">
                <span class="param-label">max:</span>
                <span class="param-value" id="footerMax">300</span>
            </div>
            <div class="param-item tooltip-hint" data-hint="Random Seed (none = random)" id="footerSeedItem" style="display: none;">
                <span class="param-label">seed:</span>
                <span class="param-value" id="footerSeed">-</span>
            </div>
        </div>
        <button class="toggle-footer-btn" id="toggleFooterBtn">Hide</button>
    </div>
</body>
</html>
